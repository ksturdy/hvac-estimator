<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Budget Estimator</title>
    <!-- Using Font Awesome for icons instead -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
            min-height: 100vh;
            padding: 1.5rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #1e40af;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .header p {
            color: #6b7280;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            color: #9ca3af;
            font-size: 0.875rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input:disabled {
            background-color: #f9fafb;
            color: #6b7280;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: #10b981;
            color: white;
            font-size: 0.875rem;
        }

        .btn-secondary:hover {
            background-color: #059669;
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
            font-size: 0.875rem;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .schedule-section {
            background-color: #fefce8;
            border: 1px solid #fde047;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .schedule-header {
            font-weight: 500;
            color: #a16207;
            margin-bottom: 0.75rem;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }

        .upload-info {
            background-color: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .upload-info h4 {
            font-weight: 500;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }

        .upload-info ul {
            font-size: 0.875rem;
            color: #1d4ed8;
            list-style: none;
            padding-left: 0;
        }

        .upload-info li {
            margin-bottom: 0.25rem;
        }

        .results-empty {
            text-align: center;
            padding: 4rem 1rem;
            color: #6b7280;
        }

        .project-summary {
            background-color: #dbeafe;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .project-summary h3 {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .project-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .main-estimate {
            background-color: #dcfce7;
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .main-estimate h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .main-estimate .amount {
            font-size: 2rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 0.5rem;
        }

        .main-estimate .per-sqft {
            font-size: 1.125rem;
            color: #6b7280;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .breakdown-total {
            border-top: 2px solid #e5e7eb;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .breakdown-total .breakdown-item {
            background-color: #eef2ff;
            padding: 1rem;
        }

        .breakdown-total .amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4f46e5;
        }

        .confidence-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.25rem;
        }

        .confidence-high {
            background-color: #dcfce7;
            color: #166534;
        }

        .confidence-medium {
            background-color: #fef3c7;
            color: #92400e;
        }

        .confidence-low {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .historical-section {
            margin-bottom: 1.5rem;
        }

        .historical-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .historical-card {
            border: 1px solid;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .historical-blue {
            background-color: #dbeafe;
            border-color: #93c5fd;
        }

        .historical-green {
            background-color: #dcfce7;
            border-color: #86efac;
        }

        .historical-card h5 {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .variance-higher {
            font-weight: bold;
            color: #dc2626;
        }

        .variance-lower {
            font-weight: bold;
            color: #16a34a;
        }

        .reference-section {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .reference-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .reference-list {
            list-style: none;
            padding: 0;
        }

        .reference-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.875rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .hidden {
            display: none;
        }

        .spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .auto-calculated {
            background-color: #dcfce7;
            color: #166534;
            padding: 0.125rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .analysis-complete {
            background-color: #dcfce7;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #166534;
            margin-top: 0.75rem;
        }

        .file-info {
            margin-top: 0.75rem;
        }

        .file-info p {
            font-weight: 500;
            color: #1f2937;
        }

        .file-info .file-size {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .loading-text {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #3b82f6;
            margin-top: 0.75rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-thermometer-half"></i>
                HVAC Budget Estimator
            </h1>
            <p>Generate accurate HVAC cost estimates with AI drawing analysis & labor curves</p>
            <p class="subtitle">Based on 168 historical projects • Automated room detection • Advanced labor scheduling</p>
        </div>

        <div class="main-grid">
            <!-- Input Panel -->
            <div class="card">
                <div class="card-header">
                    <i class="far fa-file-text"></i>
                    Project Information
                </div>

                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-input" id="projectName" placeholder="Enter project name">
                </div>

                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-input" id="projectLocation" placeholder="Enter project location">
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Square Footage *
                        <span class="auto-calculated hidden" id="autoCalculated">Auto-calculated</span>
                    </label>
                    <input type="number" class="form-input" id="squareFootage" placeholder="Enter square footage">
                </div>

                <div class="form-group">
                    <label class="form-label">Building Type *</label>
                    <select class="form-select" id="buildingType">
                        <option value="">Select building type</option>
                        <option value="New">New ($33.31/sq ft avg, 91 projects)</option>
                        <option value="Addition">Addition ($49.53/sq ft avg, 22 projects)</option>
                        <option value="Remodel">Remodel ($30.62/sq ft avg, 23 projects)</option>
                        <option value="Addition/Remodel">Addition/Remodel ($43.15/sq ft avg, 22 projects)</option>
                        <option value="Buildout">Buildout ($47.63/sq ft avg, 2 projects)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Project Type *</label>
                    <select class="form-select" id="projectType">
                        <option value="">Select project type</option>
                        <option value="School">School ($31.34/sq ft avg, 28 projects)</option>
                        <option value="Healthcare - Hospital">Healthcare - Hospital ($66.59/sq ft avg, 11 projects)</option>
                        <option value="Healthcare - Clinic">Healthcare - Clinic ($36.38/sq ft avg, 27 projects)</option>
                        <option value="Office">Office ($31.80/sq ft avg, 23 projects)</option>
                        <option value="Laboratory">Laboratory ($67.50/sq ft avg, 2 projects)</option>
                        <option value="Science Lab">Science Lab ($83.26/sq ft avg, 4 projects)</option>
                        <option value="Healthcare - Nursing Home">Healthcare - Nursing Home ($41.80/sq ft avg, 6 projects)</option>
                        <option value="Athletic Facility">Athletic Facility ($23.82/sq ft avg, 4 projects)</option>
                        <option value="Hotel">Hotel ($26.46/sq ft avg, 8 projects)</option>
                        <option value="Museum">Museum ($44.42/sq ft avg, 3 projects)</option>
                        <option value="Community Center">Community Center ($39.18/sq ft avg, 3 projects)</option>
                        <option value="Data Center">Data Center ($182.63/sq ft avg, 1 projects)</option>
                        <option value="Restaurant">Restaurant ($46.76/sq ft avg, 1 projects)</option>
                        <option value="Church">Church ($14.20/sq ft avg, 1 projects)</option>
                        <option value="Fire Station">Fire Station ($11.39/sq ft avg, 1 projects)</option>
                        <option value="Office/Warehouse">Office/Warehouse ($6.58/sq ft avg, 3 projects)</option>
                        <option value="Retail Store">Retail Store ($6.79/sq ft avg, 1 projects)</option>
                    </select>
                </div>

                <!-- Project Schedule Section -->
                <div class="schedule-section">
                    <div class="schedule-header">📅 Project Schedule (Optional)</div>
                    <div class="schedule-grid">
                        <div>
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="startDate">
                        </div>
                        <div>
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-input" id="endDate">
                        </div>
                    </div>
                    <div class="schedule-grid" style="margin-top: 0.75rem;">
                        <div>
                            <label class="form-label">Working Days/Week</label>
                            <select class="form-select" id="workingDays">
                                <option value="5">5 days (Mon-Fri)</option>
                                <option value="6">6 days (Mon-Sat)</option>
                                <option value="7">7 days (Full week)</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Hours/Day</label>
                            <select class="form-select" id="hoursPerDay">
                                <option value="8">8 hours (Standard)</option>
                                <option value="10">10 hours (Extended)</option>
                                <option value="12">12 hours (Overtime)</option>
                            </select>
                        </div>
                    </div>
                    <div style="font-size: 0.75rem; color: #a16207; margin-top: 0.5rem;">
                        💡 Adding dates enables detailed labor curve analysis showing daily worker allocation and costs
                    </div>
                </div>

                <!-- File Upload -->
                <div class="form-group">
                    <label class="form-label">Upload Architectural Drawing (Optional)</label>
                    <div class="upload-info">
                        <h4>🎯 What the Drawing Upload Does:</h4>
                        <ul>
                            <li>• <strong>Automatic Room Detection:</strong> AI analyzes your drawing to identify different room types</li>
                            <li>• <strong>Smart Area Calculation:</strong> Calculates total square footage automatically</li>
                            <li>• <strong>Room-Specific HVAC Costs:</strong> Applies different cost multipliers based on room function</li>
                            <li>• <strong>More Accurate Estimates:</strong> Server rooms, labs, and kitchens have higher HVAC requirements</li>
                        </ul>
                    </div>
                    
                    <div class="upload-area" id="uploadArea">
                        <div id="uploadContent">
                            <i class="fas fa-upload" style="font-size: 3rem; color: #9ca3af; margin: 0 auto 1rem; display: block;"></i>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;">Click to upload drawing</p>
                            <p style="font-size: 0.875rem; color: #9ca3af;">PDF, JPG, PNG, DWG files supported</p>
                        </div>
                        <div id="fileInfo" class="hidden">
                            <!-- File info will be populated here -->
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.dwg" class="hidden">
                </div>

                <div class="form-group">
                    <label class="form-label">Additional Notes</label>
                    <textarea class="form-textarea" id="projectNotes" rows="3" placeholder="Special requirements, existing conditions, etc."></textarea>
                </div>

                <button class="btn btn-primary" onclick="generateEstimate()">
                    <i class="fas fa-calculator"></i>
                    Generate Enhanced Estimate
                </button>
            </div>

            <!-- Results Panel -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div class="card-header" style="margin-bottom: 0;">
                        <i class="fas fa-dollar-sign"></i>
                        Cost Estimate
                    </div>
                    <button class="btn btn-secondary hidden" id="exportBtn" onclick="exportToExcel()">
                        <i class="fas fa-download"></i>
                        Export to Excel
                    </button>
                </div>

                <div id="resultsEmpty" class="results-empty">
                    <i class="fas fa-building" style="font-size: 4rem; color: #d1d5db; margin: 0 auto 1rem; display: block;"></i>
                    <p>Complete the form and click "Generate Enhanced Estimate"</p>
                </div>

                <div id="resultsContent" class="hidden">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>

        <!-- Historical Reference -->
        <div class="reference-section">
            <h3 style="font-size: 1.25rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem;">Historical Data Reference</h3>
            <div class="reference-grid">
                <div>
                    <h4 style="font-weight: 500; color: #374151; margin-bottom: 0.75rem;">Project Types (Top 10)</h4>
                    <ul class="reference-list">
                        <li class="reference-item">
                            <span style="color: #6b7280;">School</span>
                            <span style="font-weight: 500;">$31.34/sq ft</span>
                        </li>
                        <li class="reference-item">
                            <span style="color: #6b7280;">Healthcare - Hospital</span>
                            <span style="font-weight: 500;">$66.59/sq ft</span>
                        </li>
                        <li class="reference-item">
                            <span style="color: #6b7280;">Healthcare - Clinic</span>
                            <span style="font-weight: 500;">$36.38/sq ft</span>
                        </li>
                        <li class="reference-item">
                            <span style="color: #6b7280;">Office</span>
                            <span style="font-weight: 500;">$31.80/sq ft</span>
                        </li>
                        <li class="reference-item">
                            <span style="color: #6b7280;">Laboratory</span>
                            <span style="font-weight: 500;">$67.50/sq ft</span>
                        </li>
                        <li class="reference-item">
                            <span style="color: #6b7280;">Science Lab</span>
                            <span style="font-weight: 500;">$83.26/sq ft</span>
                        </li>
                        <li class="reference-item">
                            <span style="color: #6b7280;">Healthcare - Nursing Home</span>
                            <span style="font-weight: 500;">$41.80/sq ft</span>
                        </li>
                        <li class="reference-item">
                            <span style="color: #6b7280;">Athletic Facility</span>
                            <span style="font-weight: 500;">$23.82/sq ft</span>
                        </li>
                        <li class="reference-item">
                            <span style="color: #6b7280;">Hotel</span>
                            <span style="font-weight: 500;">$26.46/sq ft</span>
                        </li>
                        <li class="reference-item">
                            <span style="color: #6b7280;">Museum</span>
                            <span style="font-weight: 500;">$44.42/sq ft</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <h4 style="font-weight: 500; color: #374151; margin-bottom: 0.75rem;">Building Types</h4>
                    <ul class="reference-list">
                        <li class="reference-item">
                            <span style="color: #6b7280;">New</span>
                            <span style="font-weight: 500;">$33.31/sq ft</span>
                        </li>
                        <li class="reference-item">
                            <span style="color: #6b7280;">Addition</span>
                            <span style="font-weight: 500;">$49.53/sq ft</span>
                        </li>
                        <li class="reference-item">
                            <span style="color: #6b7280;">Remodel</span>
                            <span style="font-weight: 500;">$30.62/sq ft</span>
                        </li>
                        <li class="reference-item">
                            <span style="color: #6b7280;">Addition/Remodel</span>
                            <span style="font-weight: 500;">$43.15/sq ft</span>
                        </li>
                        <li class="reference-item">
                            <span style="color: #6b7280;">Buildout</span>
                            <span style="font-weight: 500;">$47.63/sq ft</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let roomAnalysis = null;
        let currentEstimate = null;
        let uploadedFile = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded successfully');
            
            // Set up event listeners
            document.getElementById('uploadArea').addEventListener('click', () => {
                if (!uploadedFile) {
                    document.getElementById('fileInput').click();
                }
            });

            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        });

        // Historical data
        const projectTypes = [
            { name: 'School', avgCost: 31.34, projects: 28 },
            { name: 'Healthcare - Hospital', avgCost: 66.59, projects: 11 },
            { name: 'Healthcare - Clinic', avgCost: 36.38, projects: 27 },
            { name: 'Office', avgCost: 31.80, projects: 23 },
            { name: 'Laboratory', avgCost: 67.50, projects: 2 },
            { name: 'Science Lab', avgCost: 83.26, projects: 4 },
            { name: 'Healthcare - Nursing Home', avgCost: 41.80, projects: 6 },
            { name: 'Athletic Facility', avgCost: 23.82, projects: 4 },
            { name: 'Hotel', avgCost: 26.46, projects: 8 },
            { name: 'Museum', avgCost: 44.42, projects: 3 },
            { name: 'Community Center', avgCost: 39.18, projects: 3 },
            { name: 'Data Center', avgCost: 182.63, projects: 1 },
            { name: 'Restaurant', avgCost: 46.76, projects: 1 },
            { name: 'Church', avgCost: 14.20, projects: 1 },
            { name: 'Fire Station', avgCost: 11.39, projects: 1 },
            { name: 'Office/Warehouse', avgCost: 6.58, projects: 3 },
            { name: 'Retail Store', avgCost: 6.79, projects: 1 }
        ];

        const buildingTypes = [
            { name: 'New', avgCost: 33.31, projects: 91 },
            { name: 'Addition', avgCost: 49.53, projects: 22 },
            { name: 'Remodel', avgCost: 30.62, projects: 23 },
            { name: 'Addition/Remodel', avgCost: 43.15, projects: 22 },
            { name: 'Buildout', avgCost: 47.63, projects: 2 }
        ];

        // Enhanced labor calculation with detailed trades and scheduling
        function calculateDetailedLabor(sqft, totalCost) {
            const laborTrades = {
                'Demolition': {
                    hoursPerKSF: 8,
                    rate: 45,
                    sequence: 1,
                    duration: 3,
                    crew: 2,
                    description: 'Remove existing HVAC equipment and ductwork'
                },
                'Site Preparation': {
                    hoursPerKSF: 4,
                    rate: 50,
                    sequence: 2,
                    duration: 2,
                    crew: 3,
                    description: 'Site setup, material staging, safety prep'
                },
                'Equipment Installation': {
                    hoursPerKSF: 15,
                    rate: 85,
                    sequence: 3,
                    duration: 8,
                    crew: 4,
                    description: 'Install RTUs, AHUs, boilers, chillers'
                },
                'Rough Piping': {
                    hoursPerKSF: 25,
                    rate: 75,
                    sequence: 4,
                    duration: 12,
                    crew: 6,
                    description: 'Install main piping runs, risers, distribution'
                },
                'Rough Ductwork': {
                    hoursPerKSF: 35,
                    rate: 65,
                    sequence: 5,
                    duration: 15,
                    crew: 8,
                    description: 'Install main ductwork, trunk lines'
                },
                'Branch Piping': {
                    hoursPerKSF: 18,
                    rate: 75,
                    sequence: 6,
                    duration: 10,
                    crew: 4,
                    description: 'Install branch piping, connections'
                },
                'Branch Ductwork': {
                    hoursPerKSF: 28,
                    rate: 65,
                    sequence: 7,
                    duration: 12,
                    crew: 6,
                    description: 'Install branch ductwork, flex connections'
                },
                'Electrical Rough-In': {
                    hoursPerKSF: 12,
                    rate: 80,
                    sequence: 8,
                    duration: 8,
                    crew: 3,
                    description: 'Install electrical feeds, panels, conduit'
                },
                'Controls Installation': {
                    hoursPerKSF: 20,
                    rate: 90,
                    sequence: 9,
                    duration: 10,
                    crew: 3,
                    description: 'Install BMS, sensors, actuators'
                },
                'Insulation': {
                    hoursPerKSF: 15,
                    rate: 55,
                    sequence: 10,
                    duration: 6,
                    crew: 4,
                    description: 'Insulate piping and ductwork'
                },
                'Air Devices': {
                    hoursPerKSF: 10,
                    rate: 60,
                    sequence: 11,
                    duration: 5,
                    crew: 3,
                    description: 'Install diffusers, grilles, registers'
                },
                'Controls Programming': {
                    hoursPerKSF: 8,
                    rate: 110,
                    sequence: 12,
                    duration: 6,
                    crew: 2,
                    description: 'Program BMS, commission controls'
                },
                'Testing & Balancing': {
                    hoursPerKSF: 12,
                    rate: 95,
                    sequence: 13,
                    duration: 8,
                    crew: 2,
                    description: 'Test all systems, balance airflow'
                },
                'Final Commissioning': {
                    hoursPerKSF: 6,
                    rate: 105,
                    sequence: 14,
                    duration: 4,
                    crew: 3,
                    description: 'Final testing, documentation, training'
                },
                'Cleanup & Closeout': {
                    hoursPerKSF: 3,
                    rate: 45,
                    sequence: 15,
                    duration: 2,
                    crew: 3,
                    description: 'Final cleanup, documentation turnover'
                }
            };

            const kSqft = sqft / 1000;
            const laborDetails = {};

            Object.entries(laborTrades).forEach(([trade, data]) => {
                const totalHours = data.hoursPerKSF * kSqft;
                const laborCost = totalHours * data.rate;
                
                laborDetails[trade] = {
                    ...data,
                    totalHours: Math.round(totalHours),
                    laborCost: Math.round(laborCost),
                    dailyHours: Math.round(totalHours / data.duration),
                    totalCrew: data.crew
                };
            });

            return laborDetails;
        }

        // Generate labor curve data based on project schedule with new bell curve algorithm
        function generateLaborCurve(laborDetails, startDate, endDate, workingDays, hoursPerDay) {
            if (!startDate || !endDate) return null;

            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Calculate total working days in project
            let totalWorkDays = 0;
            let currentDate = new Date(start);
            while (currentDate <= end) {
                if (workingDays == 7 || (workingDays == 6 && currentDate.getDay() !== 0) || (workingDays == 5 && currentDate.getDay() !== 0 && currentDate.getDay() !== 6)) {
                    totalWorkDays++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Define trade categories and their schedules
            const tradeCategories = {
                'Early Trades': {
                    trades: ['Demolition', 'Site Preparation'],
                    startPercent: 0,
                    endPercent: 15,
                    pattern: 'front-loaded'
                },
                'Equipment': {
                    trades: ['Equipment Installation'],
                    startPercent: 10,
                    endPercent: 30,
                    pattern: 'bell'
                },
                'Piping': {
                    trades: ['Rough Piping', 'Branch Piping', 'Insulation'],
                    startPercent: 0,
                    endPercent: 100,
                    pattern: 'bell'
                },
                'Sheet Metal': {
                    trades: ['Rough Ductwork', 'Branch Ductwork', 'Air Devices'],
                    startPercent: 0,
                    endPercent: 100,
                    pattern: 'bell'
                },
                'Electrical': {
                    trades: ['Electrical Rough-In'],
                    startPercent: 20,
                    endPercent: 60,
                    pattern: 'bell'
                },
                'Controls': {
                    trades: ['Controls Installation', 'Controls Programming'],
                    startPercent: 50,
                    endPercent: 100,
                    pattern: 'bell'
                },
                'Commissioning': {
                    trades: ['Testing & Balancing', 'Final Commissioning'],
                    startPercent: 50,
                    endPercent: 100,
                    pattern: 'bell'
                },
                'Closeout': {
                    trades: ['Cleanup & Closeout'],
                    startPercent: 85,
                    endPercent: 100,
                    pattern: 'back-loaded'
                }
            };

            // Create labor curve array
            const laborCurve = [];
            const tradeSchedule = [];
            currentDate = new Date(start);
            let workDay = 0;

            // Build trade schedule with realistic timing
            Object.entries(tradeCategories).forEach(([categoryName, category]) => {
                const startDay = Math.floor(totalWorkDays * category.startPercent / 100);
                const endDay = Math.floor(totalWorkDays * category.endPercent / 100);
                const categoryDuration = endDay - startDay + 1;

                category.trades.forEach(tradeName => {
                    const trade = laborDetails[tradeName];
                    if (trade) {
                        tradeSchedule.push({
                            trade: tradeName,
                            category: categoryName,
                            startDay: startDay,
                            endDay: endDay,
                            duration: categoryDuration,
                            totalHours: trade.totalHours,
                            crew: trade.totalCrew,
                            rate: trade.rate,
                            description: trade.description,
                            pattern: category.pattern
                        });
                    }
                });
            });

            // Generate daily labor data
            while (currentDate <= end) {
                if (workingDays == 7 || (workingDays == 6 && currentDate.getDay() !== 0) || (workingDays == 5 && currentDate.getDay() !== 0 && currentDate.getDay() !== 6)) {
                    const dailyData = {
                        date: new Date(currentDate).toLocaleDateString(),
                        workDay: workDay + 1,
                        totalWorkers: 0,
                        totalHours: 0,
                        totalCost: 0,
                        trades: []
                    };

                    // Calculate work for each active trade
                    tradeSchedule.forEach(tradeInfo => {
                        if (workDay >= tradeInfo.startDay && workDay <= tradeInfo.endDay) {
                            const progress = (workDay - tradeInfo.startDay) / (tradeInfo.endDay - tradeInfo.startDay);
                            let intensity = 1.0;

                            // Apply different curve patterns
                            switch (tradeInfo.pattern) {
                                case 'bell':
                                    intensity = Math.sin(progress * Math.PI);
                                    break;
                                case 'front-loaded':
                                    intensity = Math.exp(-progress * 3) * 0.9 + 0.1;
                                    break;
                                case 'back-loaded':
                                    intensity = 1 - Math.exp(-(progress * 3)) * 0.9;
                                    break;
                                default:
                                    intensity = 1.0;
                            }

                            // Calculate daily allocation
                            const dailyHoursBase = tradeInfo.totalHours / tradeInfo.duration;
                            const dailyHours = Math.round(dailyHoursBase * intensity);
                            const dailyWorkers = Math.max(1, Math.round(tradeInfo.crew * intensity));
                            const dailyCost = dailyHours * tradeInfo.rate;

                            if (dailyHours > 0) {
                                dailyData.trades.push({
                                    name: tradeInfo.trade,
                                    workers: dailyWorkers,
                                    hours: dailyHours,
                                    cost: dailyCost,
                                    progress: Math.round(progress * 100),
                                    intensity: intensity
                                });

                                dailyData.totalWorkers += dailyWorkers;
                                dailyData.totalHours += dailyHours;
                                dailyData.totalCost += dailyCost;
                            }
                        }
                    });

                    laborCurve.push(dailyData);
                    workDay++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            return {
                laborCurve,
                tradeSchedule,
                summary: {
                    totalWorkDays: workDay,
                    peakWorkers: Math.max(...laborCurve.map(d => d.totalWorkers)),
                    averageWorkers: Math.round(laborCurve.reduce((sum, d) => sum + d.totalWorkers, 0) / laborCurve.length),
                    totalLaborHours: laborCurve.reduce((sum, d) => sum + d.totalHours, 0),
                    totalLaborCost: laborCurve.reduce((sum, d) => sum + d.totalCost, 0)
                }
            };
        }

        // File upload handling
        document.getElementById('uploadArea').addEventListener('click', () => {
            if (!uploadedFile) {
                document.getElementById('fileInput').click();
            }
        });

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            uploadedFile = file;
            showFileInfo(file);
            analyzeDrawing(file);
        }

        function showFileInfo(file) {
            const uploadContent = document.getElementById('uploadContent');
            const fileInfo = document.getElementById('fileInfo');
            
            uploadContent.classList.add('hidden');
            fileInfo.classList.remove('hidden');
            
            fileInfo.innerHTML = `
                <div style="text-align: center;">
                    <i class="fas fa-check-circle" style="font-size: 3rem; color: #16a34a; margin: 0 auto 0.75rem; display: block;"></i>
                    <div class="file-info">
                        <p>${file.name}</p>
                        <p class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                    <div id="analysisStatus">
                        <div class="loading-text">
                            <div class="spinner"></div>
                            <span>Analyzing rooms and calculating areas...</span>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="clearFile()" style="margin-top: 0.75rem;">
                        <i class="fas fa-trash"></i>
                        Remove file and use manual entry
                    </button>
                </div>
            `;
        }

        function analyzeDrawing(file) {
            setTimeout(() => {
                const fileName = file.name.toLowerCase();
                
                let detectedRooms;
                
                if (fileName.includes('hospital') || fileName.includes('medical')) {
                    detectedRooms = [
                        { name: 'Patient Room 101', type: 'Patient Room', area: 280 },
                        { name: 'Surgery Suite A', type: 'Surgery', area: 500 },
                        { name: 'Laboratory', type: 'Laboratory', area: 750 },
                        { name: 'ICU Room 1', type: 'ICU', area: 288 },
                        { name: 'Emergency Room', type: 'Emergency', area: 1200 },
                        { name: 'Main Corridor', type: 'Corridor', area: 1440 }
                    ];
                } else if (fileName.includes('office')) {
                    detectedRooms = [
                        { name: 'Office 101', type: 'Office', area: 180 },
                        { name: 'Conference Room A', type: 'Conference', area: 320 },
                        { name: 'Reception Area', type: 'Reception', area: 240 },
                        { name: 'Server Room', type: 'Server Room', area: 80 },
                        { name: 'Main Corridor', type: 'Corridor', area: 600 }
                    ];
                } else {
                    detectedRooms = [
                        { name: 'Main Space', type: 'Office', area: 1200 },
                        { name: 'Conference Room', type: 'Conference', area: 300 },
                        { name: 'Reception', type: 'Reception', area: 150 },
                        { name: 'Storage', type: 'Storage', area: 80 }
                    ];
                }

                const roomsWithMultipliers = detectedRooms.map(room => ({
                    ...room,
                    hvacMultiplier: getHVACMultiplier(room.type)
                }));

                const calculatedArea = roomsWithMultipliers.reduce((sum, room) => sum + room.area, 0);
                
                roomAnalysis = {
                    totalArea: calculatedArea,
                    rooms: roomsWithMultipliers,
                    fileName: file.name,
                    analysisDate: new Date().toLocaleDateString()
                };

                document.getElementById('squareFootage').value = calculatedArea;
                document.getElementById('squareFootage').disabled = true;
                document.getElementById('autoCalculated').classList.remove('hidden');

                // Update analysis status
                document.getElementById('analysisStatus').innerHTML = `
                    <div class="analysis-complete">
                        ✅ Advanced Analysis Complete!
                        <div style="margin-top: 0.25rem;">
                            <strong>Rooms:</strong> ${roomAnalysis.rooms.length} detected • ${roomAnalysis.totalArea.toLocaleString()} sq ft total
                        </div>
                    </div>
                `;
            }, 3000);
        }

        function getHVACMultiplier(roomType) {
            const multipliers = {
                'Server Room': 4.0,
                'Surgery': 2.5,
                'Laboratory': 2.5,
                'ICU': 1.8,
                'Patient Room': 1.8,
                'Emergency': 1.6,
                'Conference': 1.2,
                'Office': 1.0,
                'Reception': 0.8,
                'Corridor': 0.3,
                'Storage': 0.3
            };
            return multipliers[roomType] || 1.0;
        }

        function clearFile() {
            uploadedFile = null;
            roomAnalysis = null;
            
            document.getElementById('fileInput').value = '';
            document.getElementById('squareFootage').value = '';
            document.getElementById('squareFootage').disabled = false;
            document.getElementById('autoCalculated').classList.add('hidden');
            
            const uploadContent = document.getElementById('uploadContent');
            const fileInfo = document.getElementById('fileInfo');
            
            uploadContent.classList.remove('hidden');
            fileInfo.classList.add('hidden');
        }

        function generateEstimate() {
            const squareFootage = document.getElementById('squareFootage').value;
            const buildingType = document.getElementById('buildingType').value;
            const projectType = document.getElementById('projectType').value;

            if (!squareFootage || !buildingType || !projectType) {
                alert('Please fill in Square Footage, Building Type, and Project Type');
                return;
            }

            const project = {
                name: document.getElementById('projectName').value || 'Unnamed Project',
                location: document.getElementById('projectLocation').value,
                squareFootage: squareFootage,
                buildingType: buildingType,
                projectType: projectType,
                notes: document.getElementById('projectNotes').value
            };

            const sqft = parseFloat(squareFootage);
            const selectedProjectType = projectTypes.find(type => type.name === projectType);
            const selectedBuildingType = buildingTypes.find(type => type.name === buildingType);

            let baseCostPerSqft = selectedProjectType?.avgCost || 36.85;
            const buildingMultiplier = selectedBuildingType ? selectedBuildingType.avgCost / 36.85 : 1.0;
            let adjustedCostPerSqft = baseCostPerSqft * buildingMultiplier;

            if (roomAnalysis) {
                let weightedTotal = 0;
                roomAnalysis.rooms.forEach(room => {
                    const roomCost = adjustedCostPerSqft * room.hvacMultiplier;
                    weightedTotal += roomCost * room.area;
                });
                adjustedCostPerSqft = weightedTotal / roomAnalysis.totalArea;
            }

            const totalCost = sqft * adjustedCostPerSqft;

            // Generate detailed labor analysis
            const detailedLabor = calculateDetailedLabor(sqft, totalCost);

            const breakdown = {
                equipment: { total: totalCost * 0.35 },
                sheetMetal: { total: totalCost * 0.25 },
                piping: { total: totalCost * 0.15 },
                controls: { total: totalCost * 0.10 },
                labor: { total: totalCost * 0.20 },
                overhead: { total: totalCost * 0.15 }
            };

            let roomCosts = null;
            if (roomAnalysis) {
                roomCosts = {};
                const roomTypes = roomAnalysis.rooms.reduce((acc, room) => {
                    if (!acc[room.type]) {
                        acc[room.type] = { count: 0, totalArea: 0, rooms: [] };
                    }
                    acc[room.type].count++;
                    acc[room.type].totalArea += room.area;
                    acc[room.type].rooms.push(room.name);
                    return acc;
                }, {});

                Object.entries(roomTypes).forEach(([roomType, data]) => {
                    const avgMultiplier = roomAnalysis.rooms
                        .filter(room => room.type === roomType)
                        .reduce((sum, room) => sum + room.hvacMultiplier, 0) / data.count;
                    
                    const roomCostPerSqft = adjustedCostPerSqft * avgMultiplier;
                    roomCosts[roomType] = {
                        area: data.totalArea,
                        costPerSqft: roomCostPerSqft,
                        totalCost: data.totalArea * roomCostPerSqft,
                        rooms: data.rooms
                    };
                });
            }

            currentEstimate = {
                project,
                totalCost,
                costPerSqft: adjustedCostPerSqft,
                breakdown,
                roomCosts,
                detailedLabor,
                confidence: selectedProjectType?.projects > 5 ? 'High' : selectedProjectType?.projects > 1 ? 'Medium' : 'Low',
                generatedDate: new Date().toLocaleDateString()
            };

            // Generate labor curve if schedule dates are provided
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const workingDays = parseInt(document.getElementById('workingDays').value);
            const hoursPerDay = parseInt(document.getElementById('hoursPerDay').value);

            if (startDate && endDate) {
                const laborSchedule = generateLaborCurve(detailedLabor, startDate, endDate, workingDays, hoursPerDay);
                currentEstimate.laborSchedule = laborSchedule;
            }

            displayResults(currentEstimate);
        }

        function displayResults(estimate) {
            document.getElementById('resultsEmpty').classList.add('hidden');
            document.getElementById('resultsContent').classList.remove('hidden');
            document.getElementById('exportBtn').classList.remove('hidden');

            const resultsContent = document.getElementById('resultsContent');
            
            resultsContent.innerHTML = `
                <!-- Project Summary -->
                <div class="project-summary">
                    <h3>${estimate.project.name}</h3>
                    <div class="project-grid">
                        <div><span style="color: #6b7280;">Size:</span> ${parseInt(estimate.project.squareFootage).toLocaleString()} sq ft</div>
                        <div><span style="color: #6b7280;">Type:</span> ${estimate.project.projectType}</div>
                        <div><span style="color: #6b7280;">Category:</span> ${estimate.project.buildingType}</div>
                        <div>
                            <span style="color: #6b7280;">Confidence:</span>
                            <span class="confidence-badge confidence-${estimate.confidence.toLowerCase()}">${estimate.confidence}</span>
                        </div>
                    </div>
                </div>

                <!-- Main Estimate -->
                <div class="main-estimate">
                    <h3>Total Estimated Cost</h3>
                    <div class="amount">${formatCurrency(estimate.totalCost)}</div>
                    <div class="per-sqft">$${estimate.costPerSqft.toFixed(2)} per sq ft</div>
                </div>

                <!-- Historical Comparison -->
                <div class="historical-section">
                    <h4 style="font-weight: 600; color: #1f2937; margin-bottom: 0.75rem;">📊 Project vs Historical Data</h4>
                    <div class="historical-grid">
                        ${generateHistoricalComparison(estimate)}
                    </div>
                </div>

                <!-- Cost Breakdown -->
                <div>
                    <h4 style="font-weight: 600; color: #1f2937; margin-bottom: 1rem;">Cost Breakdown</h4>
                    
                    <div class="breakdown-item" style="background-color: #dbeafe;">
                        <span style="font-weight: 500; color: #1f2937;">HVAC Equipment (35%)</span>
                        <span style="font-weight: 600; color: #2563eb;">${formatCurrency(estimate.breakdown.equipment.total)}</span>
                    </div>
                    
                    <div class="breakdown-item" style="background-color: #dcfce7;">
                        <span style="font-weight: 500; color: #1f2937;">Sheet Metal & Ductwork (25%)</span>
                        <span style="font-weight: 600; color: #16a34a;">${formatCurrency(estimate.breakdown.sheetMetal.total)}</span>
                    </div>
                    
                    <div class="breakdown-item" style="background-color: #f3e8ff;">
                        <span style="font-weight: 500; color: #1f2937;">Piping & Hydronic (15%)</span>
                        <span style="font-weight: 600; color: #7c3aed;">${formatCurrency(estimate.breakdown.piping.total)}</span>
                    </div>
                    
                    <div class="breakdown-item" style="background-color: #fef3c7;">
                        <span style="font-weight: 500; color: #1f2937;">Controls & Electrical (10%)</span>
                        <span style="font-weight: 600; color: #d97706;">${formatCurrency(estimate.breakdown.controls.total)}</span>
                    </div>
                    
                    <div class="breakdown-item" style="background-color: #fed7aa;">
                        <span style="font-weight: 500; color: #1f2937;">Installation Labor (20%)</span>
                        <span style="font-weight: 600; color: #ea580c;">${formatCurrency(estimate.breakdown.labor.total)}</span>
                    </div>
                    
                    <div class="breakdown-item" style="background-color: #f3f4f6;">
                        <span style="font-weight: 500; color: #1f2937;">Overhead & Markup (15%)</span>
                        <span style="font-weight: 600; color: #6b7280;">${formatCurrency(estimate.breakdown.overhead.total)}</span>
                    </div>

                    <div class="breakdown-total">
                        <div class="breakdown-item">
                            <span style="font-size: 1.125rem; font-weight: 600; color: #1f2937;">TOTAL PROJECT COST</span>
                            <span class="amount">${formatCurrency(estimate.totalCost)}</span>
                        </div>
                    </div>
                </div>

                ${estimate.roomCosts ? generateRoomAnalysis(estimate.roomCosts) : ''}

                ${estimate.detailedLabor ? generateLaborAnalysis(estimate) : ''}
            `;
        }

        function generateHistoricalComparison(estimate) {
            const projectTypeMatch = projectTypes.find(type => type.name === estimate.project.projectType);
            const buildingTypeMatch = buildingTypes.find(type => type.name === estimate.project.buildingType);

            let projectTypeHtml = '<div class="text-sm" style="color: #dc2626;">No historical match found</div>';
            let buildingTypeHtml = '<div class="text-sm" style="color: #dc2626;">No historical match found</div>';

            if (projectTypeMatch) {
                const variance = ((estimate.costPerSqft - projectTypeMatch.avgCost) / projectTypeMatch.avgCost * 100);
                const isHigher = variance > 0;
                projectTypeHtml = `
                    <div style="font-size: 0.875rem; line-height: 1.5;">
                        <div>Type: <strong>${projectTypeMatch.name}</strong></div>
                        <div>Historical Avg: <strong>$${projectTypeMatch.avgCost.toFixed(2)}/sq ft</strong></div>
                        <div>Your Estimate: <strong>$${estimate.costPerSqft.toFixed(2)}/sq ft</strong></div>
                        <div class="${isHigher ? 'variance-higher' : 'variance-lower'}">
                            ${variance.toFixed(1)}% ${isHigher ? 'HIGHER' : 'LOWER'}
                        </div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Based on ${projectTypeMatch.projects} projects</div>
                    </div>
                `;
            }

            if (buildingTypeMatch) {
                const variance = ((estimate.costPerSqft - buildingTypeMatch.avgCost) / buildingTypeMatch.avgCost * 100);
                const isHigher = variance > 0;
                buildingTypeHtml = `
                    <div style="font-size: 0.875rem; line-height: 1.5;">
                        <div>Category: <strong>${buildingTypeMatch.name}</strong></div>
                        <div>Category Avg: <strong>$${buildingTypeMatch.avgCost.toFixed(2)}/sq ft</strong></div>
                        <div>Your Estimate: <strong>$${estimate.costPerSqft.toFixed(2)}/sq ft</strong></div>
                        <div class="${isHigher ? 'variance-higher' : 'variance-lower'}">
                            ${variance.toFixed(1)}% ${isHigher ? 'HIGHER' : 'LOWER'}
                        </div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Based on ${buildingTypeMatch.projects} buildings</div>
                    </div>
                `;
            }

            return `
                <div class="historical-card historical-blue">
                    <h5 style="color: #1e40af;">Project Type Analysis</h5>
                    ${projectTypeHtml}
                </div>
                <div class="historical-card historical-green">
                    <h5 style="color: #166534;">Building Type Analysis</h5>
                    ${buildingTypeHtml}
                </div>
            `;
        }

        function generateRoomAnalysis(roomCosts) {
            const roomItems = Object.entries(roomCosts).map(([roomType, data]) => `
                <div style="background-color: #f9fafb; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                        <span style="font-weight: 500;">${roomType}</span>
                        <span style="font-weight: 600; color: #2563eb;">${formatCurrency(data.totalCost)}</span>
                    </div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        ${data.area} sq ft × $${data.costPerSqft.toFixed(2)}/sq ft
                    </div>
                </div>
            `).join('');

            return `
                <div style="margin-top: 1.5rem;">
                    <h4 style="font-weight: 600; color: #1f2937; margin-bottom: 0.75rem;">Room-Specific Analysis</h4>
                    ${roomItems}
                </div>
            `;
        }

        function generateLaborAnalysis(estimate) {
            if (!estimate.detailedLabor) return '';

            const laborItems = Object.entries(estimate.detailedLabor)
                .sort((a, b) => a[1].sequence - b[1].sequence)
                .map(([trade, data]) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: white; border-radius: 0.375rem; border: 1px solid #e5e7eb; margin-bottom: 0.5rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; font-size: 0.875rem;">${trade}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">${data.description}</div>
                        </div>
                        <div style="text-align: right; font-size: 0.75rem;">
                            <div style="font-weight: 600;">${formatCurrency(data.laborCost)}</div>
                            <div style="color: #6b7280;">${data.totalHours}h • ${data.crew} workers</div>
                        </div>
                    </div>
                `).join('');

            const totalLaborCost = Object.values(estimate.detailedLabor).reduce((sum, trade) => sum + trade.laborCost, 0);

            let laborCurveHtml = '';
            if (estimate.laborSchedule) {
                laborCurveHtml = `
                    <div style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.75rem;">
                            <h5 style="font-weight: 500; color: #4f46e5; margin: 0;">📈 Labor Curve Analysis</h5>
                            <button class="btn" style="background-color: #6366f1; color: white; padding: 0.25rem 0.75rem; font-size: 0.875rem;" onclick="toggleLaborCurve()">
                                <span id="laborCurveToggle">Show</span> Labor Curve
                            </button>
                        </div>
                        
                        <div id="laborCurveContent" class="hidden">
                            ${generateLaborCurveDisplay(estimate.laborSchedule)}
                        </div>
                    </div>
                `;
            }

            return `
                <div style="margin-top: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <h4 style="font-weight: 600; color: #1f2937; margin: 0;">⚡ Detailed Labor Analysis</h4>
                    </div>

                    <div style="background-color: #f3e8ff; padding: 1rem; border-radius: 0.5rem; border: 1px solid #c4b5fd;">
                        <h5 style="font-weight: 500; color: #7c3aed; margin-bottom: 0.75rem;">Labor Breakdown by Trade</h5>
                        <div style="max-height: 12rem; overflow-y: auto;">
                            ${laborItems}
                        </div>
                        <div style="border-top: 1px solid #c4b5fd; padding-top: 0.5rem; margin-top: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; font-weight: 600;">
                                <span>Total Labor Cost:</span>
                                <span style="color: #7c3aed;">${formatCurrency(totalLaborCost)}</span>
                            </div>
                        </div>
                    </div>

                    ${laborCurveHtml}
                </div>
            `;
        }

        function generateLaborCurveDisplay(laborSchedule) {
            return `
                <div style="background-color: #eef2ff; padding: 1rem; border-radius: 0.5rem; border: 1px solid #c7d2fe;">
                    <!-- Summary Stats -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: white; padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                            <div style="font-size: 1.125rem; font-weight: bold; color: #4f46e5;">${laborSchedule.summary.totalWorkDays}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">Work Days</div>
                        </div>
                        <div style="background: white; padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                            <div style="font-size: 1.125rem; font-weight: bold; color: #4f46e5;">${laborSchedule.summary.peakWorkers}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">Peak Workers</div>
                        </div>
                        <div style="background: white; padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                            <div style="font-size: 1.125rem; font-weight: bold; color: #4f46e5;">${laborSchedule.summary.averageWorkers}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">Avg Workers</div>
                        </div>
                    </div>

                    <!-- Labor Curve Chart -->
                    <div style="background: white; padding: 1rem; border-radius: 0.375rem;">
                        <h6 style="font-weight: 500; margin-bottom: 0.75rem;">📈 Labor Curve - Workers Over Time</h6>
                        
                        <!-- Chart Area -->
                        <div style="position: relative; background-color: #f9fafb; padding: 1rem; border-radius: 0.375rem; height: 300px;">
                            ${generateSVGChart(laborSchedule)}
                        </div>

                        <!-- Legend -->
                        <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.75rem;">
                            <div style="display: flex; align-items: center;">
                                <div style="width: 1rem; height: 2px; background-color: #4f46e5; margin-right: 0.5rem;"></div>
                                <span>Total Workers</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div style="width: 1rem; height: 2px; background: repeating-linear-gradient(to right, #10b981 0, #10b981 5px, transparent 5px, transparent 10px); margin-right: 0.5rem;"></div>
                                <span>Sheet Metal</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div style="width: 1rem; height: 2px; background: repeating-linear-gradient(to right, #f59e0b 0, #f59e0b 3px, transparent 3px, transparent 6px); margin-right: 0.5rem;"></div>
                                <span>Piping</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div style="width: 1rem; height: 2px; background: repeating-linear-gradient(to right, #ef4444 0, #ef4444 8px, transparent 8px, transparent 10px); margin-right: 0.5rem;"></div>
                                <span>Equipment</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div style="width: 1rem; height: 2px; background: repeating-linear-gradient(to right, #8b5cf6 0, #8b5cf6 2px, transparent 2px, transparent 4px); margin-right: 0.5rem;"></div>
                                <span>Controls</span>
                            </div>
                        </div>

                        <!-- Peak Analysis -->
                        <div style="margin-top: 1rem; background-color: #dbeafe; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #93c5fd;">
                            <h6 style="font-weight: 500; color: #1e40af; margin-bottom: 0.5rem;">📊 Peak Workforce Analysis</h6>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.75rem;">
                                <div>
                                    <div style="font-weight: 500;">Peak Sheet Metal: ${getMaxTradeWorkers(laborSchedule, ['Ductwork', 'Air Devices'])} workers</div>
                                    <div style="color: #6b7280;">During ductwork installation phase</div>
                                </div>
                                <div>
                                    <div style="font-weight: 500;">Peak Piping: ${getMaxTradeWorkers(laborSchedule, ['Piping', 'Insulation'])} workers</div>
                                    <div style="color: #6b7280;">During piping installation phase</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px solid #93c5fd;">
                                <div style="font-size: 0.75rem; color: #1d4ed8;">
                                    <strong>Timeline:</strong> ${laborSchedule.summary.totalWorkDays} work days 
                                    (${laborSchedule.laborCurve[0]?.date} to ${laborSchedule.laborCurve[laborSchedule.laborCurve.length - 1]?.date})
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trade Schedule -->
                    <div style="background: white; padding: 0.75rem; border-radius: 0.375rem; margin-top: 0.75rem;">
                        <h6 style="font-weight: 500; margin-bottom: 0.5rem;">Trade Schedule</h6>
                        <div style="max-height: 8rem; overflow-y: auto;">
                            ${laborSchedule.tradeSchedule.map((trade, index) => `
                                <div key="${index}" style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; padding: 0.5rem; background-color: #f9fafb; border-radius: 0.375rem; margin-bottom: 0.5rem;">
                                    <div>
                                        <div style="font-weight: 500;">${trade.trade}</div>
                                        <div style="color: #6b7280;">Days ${trade.startDay + 1}-${trade.endDay + 1}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 500;">${trade.crew} workers</div>
                                        <div style="color: #6b7280;">${trade.totalHours}h total</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateSVGChart(laborSchedule) {
            const curve = laborSchedule.laborCurve;
            const maxWorkers = laborSchedule.summary.peakWorkers;
            
            // Generate points for total workers line
            const totalPoints = curve.map((day, index) => {
                const x = curve.length > 1 ? (index / (curve.length - 1)) * 400 : 200;
                const y = maxWorkers > 0 ? 260 - (day.totalWorkers / maxWorkers) * 260 : 260;
                return `${x},${y}`;
            }).join(' ');

            return `
                <!-- Y-axis labels -->
                <div style="position: absolute; left: 0; top: 0; height: 260px; display: flex; flex-direction: column; justify-content: space-between; font-size: 0.75rem; color: #6b7280; padding-right: 0.5rem;">
                    <span>${maxWorkers}</span>
                    <span>${Math.round(maxWorkers * 0.75)}</span>
                    <span>${Math.round(maxWorkers * 0.5)}</span>
                    <span>${Math.round(maxWorkers * 0.25)}</span>
                    <span>0</span>
                </div>
                
                <!-- Chart content -->
                <div style="margin-left: 2rem; height: 260px; position: relative;">
                    <!-- SVG Chart -->
                    <svg style="position: absolute; inset: 0; width: 100%; height: 100%;" viewBox="0 0 400 260" preserveAspectRatio="none">
                        <!-- Grid lines -->
                        ${[0, 0.25, 0.5, 0.75, 1].map(ratio => `
                            <line x1="0" y1="${260 - (ratio * 260)}" x2="400" y2="${260 - (ratio * 260)}" stroke="#e5e7eb" stroke-width="1" vector-effect="non-scaling-stroke" />
                        `).join('')}
                        ${[0, 0.25, 0.5, 0.75, 1].map(ratio => `
                            <line x1="${ratio * 400}" y1="0" x2="${ratio * 400}" y2="260" stroke="#e5e7eb" stroke-width="1" vector-effect="non-scaling-stroke" />
                        `).join('')}

                        <!-- Total Workers Line -->
                        <polyline fill="none" stroke="#4f46e5" stroke-width="3" vector-effect="non-scaling-stroke" points="${totalPoints}" />
                    </svg>
                </div>
                
                <!-- X-axis labels -->
                <div style="position: absolute; bottom: 0; left: 2rem; right: 0; display: flex; justify-content: space-between; font-size: 0.75rem; color: #6b7280; padding-top: 0.5rem;">
                    ${curve.length > 0 ? `
                        <span>${curve[0]?.date}</span>
                        ${curve.length > 4 ? `
                            <span>${curve[Math.floor(curve.length / 4)]?.date}</span>
                            <span>${curve[Math.floor(curve.length / 2)]?.date}</span>
                            <span>${curve[Math.floor(curve.length * 3 / 4)]?.date}</span>
                        ` : ''}
                        <span>${curve[curve.length - 1]?.date}</span>
                    ` : ''}
                </div>
            `;
        }

        function getMaxTradeWorkers(laborSchedule, tradeKeywords) {
            return Math.max(...laborSchedule.laborCurve.map(day => 
                day.trades.filter(trade => tradeKeywords.some(keyword => trade.name.includes(keyword)))
                    .reduce((sum, trade) => sum + trade.workers, 0)
            ), 0);
        }

        function toggleLaborCurve() {
            const content = document.getElementById('laborCurveContent');
            const toggle = document.getElementById('laborCurveToggle');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                toggle.textContent = 'Hide';
            } else {
                content.classList.add('hidden');
                toggle.textContent = 'Show';
            }
        }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function exportToExcel() {
            if (!currentEstimate) {
                alert('Please generate an estimate first');
                return;
            }
            
            alert('Export feature would generate a detailed CSV file with all project data, cost breakdowns, and historical comparisons.');
        }
    </script>
</body>
</html>
