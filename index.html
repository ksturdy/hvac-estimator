import React, { useState, useRef } from 'react';
import { Upload, Calculator, FileText, DollarSign, Building, Thermometer, Download, Trash2, CheckCircle } from 'lucide-react';

const HVACEstimator = () => {
  const [project, setProject] = useState({
    name: '',
    location: '',
    squareFootage: '',
    buildingType: '',
    projectType: '',
    notes: ''
  });

  const [uploadedFile, setUploadedFile] = useState(null);
  const [roomAnalysis, setRoomAnalysis] = useState(null);
  const [estimate, setEstimate] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const fileInputRef = useRef(null);

  // Historical data from your spreadsheet
  const projectTypes = [
    { name: 'School', avgCost: 31.34, projects: 28 },
    { name: 'Healthcare - Hospital', avgCost: 66.59, projects: 11 },
    { name: 'Healthcare - Clinic', avgCost: 36.38, projects: 27 },
    { name: 'Office', avgCost: 31.80, projects: 23 },
    { name: 'Laboratory', avgCost: 67.50, projects: 2 },
    { name: 'Science Lab', avgCost: 83.26, projects: 4 },
    { name: 'Healthcare - Nursing Home', avgCost: 41.80, projects: 6 },
    { name: 'Athletic Facility', avgCost: 23.82, projects: 4 },
    { name: 'Hotel', avgCost: 26.46, projects: 8 },
    { name: 'Museum', avgCost: 44.42, projects: 3 },
    { name: 'Community Center', avgCost: 39.18, projects: 3 },
    { name: 'Data Center', avgCost: 182.63, projects: 1 },
    { name: 'Restaurant', avgCost: 46.76, projects: 1 },
    { name: 'Church', avgCost: 14.20, projects: 1 },
    { name: 'Fire Station', avgCost: 11.39, projects: 1 },
    { name: 'Office/Warehouse', avgCost: 6.58, projects: 3 },
    { name: 'Retail Store', avgCost: 6.79, projects: 1 }
  ];

  const buildingTypes = [
    { name: 'New', avgCost: 33.31, projects: 91 },
    { name: 'Addition', avgCost: 49.53, projects: 22 },
    { name: 'Remodel', avgCost: 30.62, projects: 23 },
    { name: 'Addition/Remodel', avgCost: 43.15, projects: 22 },
    { name: 'Buildout', avgCost: 47.63, projects: 2 }
  ];

  // Sample historical projects
  const historicalProjects = [
    { name: 'UW Eau Claire Student Center', date: '1/11/11', type: 'New', category: 'School', cost: 4190322, sqft: 169286, costPerSqft: 24.75 },
    { name: 'Langlade Hospital', date: '1/20/11', type: 'New', category: 'Healthcare - Hospital', cost: 3871947, sqft: 95798, costPerSqft: 40.42 },
    { name: 'MTU Research Center', date: '4/14/11', type: 'New', category: 'Laboratory', cost: 3849852, sqft: 54778, costPerSqft: 70.28 },
    { name: 'Waukesha Human Services', date: '6/7/11', type: 'New', category: 'Office', cost: 4256366, sqft: 138000, costPerSqft: 30.84 },
    { name: 'Diversey Family YMCA', date: '6/23/11', type: 'New', category: 'Athletic Facility', cost: 1255763, sqft: 70069, costPerSqft: 17.92 },
    { name: 'Madison Truax HEB', date: '8/2/11', type: 'New', category: 'School', cost: 5039458, sqft: 176000, costPerSqft: 28.63 },
    { name: 'Wade House Museum', date: '8/11/11', type: 'New', category: 'Museum', cost: 1288749, sqft: 37800, costPerSqft: 34.09 },
    { name: 'Rock Haven Nursing Home', date: '8/22/11', type: 'New', category: 'Healthcare - Nursing Home', cost: 5652173, sqft: 178000, costPerSqft: 31.75 }
  ];

  // Handle file upload and analysis
  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    console.log('File uploaded:', file.name, file.type, file.size);
    setUploadedFile(file);
    
    // Start room analysis
    analyzeDrawing(file);
  };

  // Improved drawing analysis with scale detection and measurement
  const analyzeDrawing = (file) => {
    setIsAnalyzing(true);
    
    // Simulate advanced drawing analysis with scale detection
    setTimeout(() => {
      const fileName = file.name.toLowerCase();
      
      // Simulate scale detection from drawing
      const detectedScales = ['1/4" = 1\'', '1/8" = 1\'', '1/16" = 1\'', '3/32" = 1\'', '1" = 10\'', '1" = 20\''];
      const detectedScale = detectedScales[Math.floor(Math.random() * detectedScales.length)];
      
      // Convert scale to ratio for calculations
      let scaleRatio = 48; // Default 1/4" = 1' (48:1)
      if (detectedScale.includes('1/8"')) scaleRatio = 96;
      else if (detectedScale.includes('1/16"')) scaleRatio = 192;
      else if (detectedScale.includes('3/32"')) scaleRatio = 128;
      else if (detectedScale.includes('1" = 10\'')) scaleRatio = 10;
      else if (detectedScale.includes('1" = 20\'')) scaleRatio = 20;
      
      // Simulate actual drawing measurements (in drawing units)
      let buildingLength, buildingWidth, detectedRooms;
      
      if (fileName.includes('hospital') || fileName.includes('medical')) {
        // Hospital building - typically 200' x 150'
        buildingLength = 200;
        buildingWidth = 150;
        detectedRooms = [
          { name: 'Patient Room 101', type: 'Patient Room', measuredLength: 14, measuredWidth: 20, area: 280 },
          { name: 'Patient Room 102', type: 'Patient Room', measuredLength: 14, measuredWidth: 20, area: 280 },
          { name: 'Patient Room 103', type: 'Patient Room', measuredLength: 14, measuredWidth: 20, area: 280 },
          { name: 'Surgery Suite A', type: 'Surgery', measuredLength: 20, measuredWidth: 25, area: 500 },
          { name: 'Surgery Suite B', type: 'Surgery', measuredLength: 18, measuredWidth: 22, area: 396 },
          { name: 'Laboratory', type: 'Laboratory', measuredLength: 25, measuredWidth: 30, area: 750 },
          { name: 'Pharmacy', type: 'Medical Support', measuredLength: 12, measuredWidth: 15, area: 180 },
          { name: 'Central Waiting', type: 'Waiting', measuredLength: 30, measuredWidth: 20, area: 600 },
          { name: 'Nurse Station', type: 'Medical Support', measuredLength: 10, measuredWidth: 12, area: 120 },
          { name: 'ICU Room 1', type: 'ICU', measuredLength: 16, measuredWidth: 18, area: 288 },
          { name: 'ICU Room 2', type: 'ICU', measuredLength: 16, measuredWidth: 18, area: 288 },
          { name: 'Emergency Room', type: 'Emergency', measuredLength: 40, measuredWidth: 30, area: 1200 },
          { name: 'Radiology', type: 'Medical Equipment', measuredLength: 20, measuredWidth: 25, area: 500 },
          { name: 'Main Corridor', type: 'Corridor', measuredLength: 180, measuredWidth: 8, area: 1440 },
          { name: 'East Corridor', type: 'Corridor', measuredLength: 120, measuredWidth: 6, area: 720 },
          { name: 'West Corridor', type: 'Corridor', measuredLength: 120, measuredWidth: 6, area: 720 },
          { name: 'Restroom 1M', type: 'Restroom', measuredLength: 10, measuredWidth: 8, area: 80 },
          { name: 'Restroom 1F', type: 'Restroom', measuredLength: 10, measuredWidth: 8, area: 80 },
          { name: 'Restroom 2M', type: 'Restroom', measuredLength: 10, measuredWidth: 8, area: 80 },
          { name: 'Restroom 2F', type: 'Restroom', measuredLength: 10, measuredWidth: 8, area: 80 },
          { name: 'Mechanical Room', type: 'Mechanical', measuredLength: 20, measuredWidth: 15, area: 300 },
          { name: 'Electrical Room', type: 'Electrical', measuredLength: 12, measuredWidth: 10, area: 120 },
          { name: 'Storage 1', type: 'Storage', measuredLength: 8, measuredWidth: 10, area: 80 },
          { name: 'Storage 2', type: 'Storage', measuredLength: 8, measuredWidth: 10, area: 80 },
          { name: 'Janitor Closet', type: 'Storage', measuredLength: 6, measuredWidth: 8, area: 48 }
        ];
      } else if (fileName.includes('office')) {
        // Office building - typically 120' x 80'
        buildingLength = 120;
        buildingWidth = 80;
        detectedRooms = [
          { name: 'Office 101', type: 'Office', measuredLength: 12, measuredWidth: 15, area: 180 },
          { name: 'Office 102', type: 'Office', measuredLength: 14, measuredWidth: 15, area: 210 },
          { name: 'Office 103', type: 'Office', measuredLength: 12, measuredWidth: 14, area: 168 },
          { name: 'Office 104', type: 'Office', measuredLength: 10, measuredWidth: 16, area: 160 },
          { name: 'Office 105', type: 'Office', measuredLength: 12, measuredWidth: 15, area: 180 },
          { name: 'Conference Room A', type: 'Conference', measuredLength: 20, measuredWidth: 16, area: 320 },
          { name: 'Conference Room B', type: 'Conference', measuredLength: 16, measuredWidth: 14, area: 224 },
          { name: 'Large Conference', type: 'Conference', measuredLength: 24, measuredWidth: 18, area: 432 },
          { name: 'Reception Area', type: 'Reception', measuredLength: 20, measuredWidth: 12, area: 240 },
          { name: 'Waiting Area', type: 'Waiting', measuredLength: 15, measuredWidth: 10, area: 150 },
          { name: 'Break Room', type: 'Break Room', measuredLength: 15, measuredWidth: 12, area: 180 },
          { name: 'Kitchen', type: 'Kitchen', measuredLength: 12, measuredWidth: 10, area: 120 },
          { name: 'Server Room', type: 'Server Room', measuredLength: 10, measuredWidth: 8, area: 80 },
          { name: 'IT Storage', type: 'Storage', measuredLength: 8, measuredWidth: 6, area: 48 },
          { name: 'Copy Room', type: 'Office Support', measuredLength: 8, measuredWidth: 10, area: 80 },
          { name: 'Supply Storage', type: 'Storage', measuredLength: 10, measuredWidth: 8, area: 80 },
          { name: 'Main Corridor', type: 'Corridor', measuredLength: 100, measuredWidth: 6, area: 600 },
          { name: 'East Corridor', type: 'Corridor', measuredLength: 60, measuredWidth: 5, area: 300 },
          { name: 'Restroom 1M', type: 'Restroom', measuredLength: 8, measuredWidth: 6, area: 48 },
          { name: 'Restroom 1F', type: 'Restroom', measuredLength: 8, measuredWidth: 6, area: 48 },
          { name: 'Restroom 2M', type: 'Restroom', measuredLength: 8, measuredWidth: 6, area: 48 },
          { name: 'Restroom 2F', type: 'Restroom', measuredLength: 8, measuredWidth: 6, area: 48 },
          { name: 'Mechanical Room', type: 'Mechanical', measuredLength: 12, measuredWidth: 10, area: 120 },
          { name: 'Electrical Room', type: 'Electrical', measuredLength: 8, measuredWidth: 8, area: 64 },
          { name: 'Janitor Closet', type: 'Storage', measuredLength: 6, measuredWidth: 6, area: 36 }
        ];
      } else if (fileName.includes('school')) {
        // School building - typically 300' x 200'
        buildingLength = 300;
        buildingWidth = 200;
        detectedRooms = [
          { name: 'Classroom 101', type: 'Classroom', measuredLength: 30, measuredWidth: 24, area: 720 },
          { name: 'Classroom 102', type: 'Classroom', measuredLength: 30, measuredWidth: 24, area: 720 },
          { name: 'Classroom 103', type: 'Classroom', measuredLength: 30, measuredWidth: 24, area: 720 },
          { name: 'Classroom 104', type: 'Classroom', measuredLength: 30, measuredWidth: 24, area: 720 },
          { name: 'Classroom 105', type: 'Classroom', measuredLength: 30, measuredWidth: 24, area: 720 },
          { name: 'Classroom 106', type: 'Classroom', measuredLength: 30, measuredWidth: 24, area: 720 },
          { name: 'Science Lab A', type: 'Science Lab', measuredLength: 35, measuredWidth: 28, area: 980 },
          { name: 'Science Lab B', type: 'Science Lab', measuredLength: 35, measuredWidth: 28, area: 980 },
          { name: 'Computer Lab', type: 'Computer Lab', measuredLength: 32, measuredWidth: 26, area: 832 },
          { name: 'Library', type: 'Library', measuredLength: 50, measuredWidth: 40, area: 2000 },
          { name: 'Cafeteria', type: 'Cafeteria', measuredLength: 60, measuredWidth: 40, area: 2400 },
          { name: 'Kitchen', type: 'Kitchen', measuredLength: 25, measuredWidth: 20, area: 500 },
          { name: 'Gymnasium', type: 'Gymnasium', measuredLength: 80, measuredWidth: 50, area: 4000 },
          { name: 'Auditorium', type: 'Auditorium', measuredLength: 60, measuredWidth: 45, area: 2700 },
          { name: 'Principal Office', type: 'Office', measuredLength: 14, measuredWidth: 12, area: 168 },
          { name: 'Admin Office 1', type: 'Office', measuredLength: 12, measuredWidth: 10, area: 120 },
          { name: 'Admin Office 2', type: 'Office', measuredLength: 12, measuredWidth: 10, area: 120 },
          { name: 'Teachers Lounge', type: 'Break Room', measuredLength: 20, measuredWidth: 15, area: 300 },
          { name: 'Main Corridor', type: 'Corridor', measuredLength: 280, measuredWidth: 10, area: 2800 },
          { name: 'North Corridor', type: 'Corridor', measuredLength: 180, measuredWidth: 8, area: 1440 },
          { name: 'South Corridor', type: 'Corridor', measuredLength: 180, measuredWidth: 8, area: 1440 },
          { name: 'Boys Restroom 1', type: 'Restroom', measuredLength: 15, measuredWidth: 12, area: 180 },
          { name: 'Girls Restroom 1', type: 'Restroom', measuredLength: 15, measuredWidth: 12, area: 180 },
          { name: 'Boys Restroom 2', type: 'Restroom', measuredLength: 15, measuredWidth: 12, area: 180 },
          { name: 'Girls Restroom 2', type: 'Restroom', measuredLength: 15, measuredWidth: 12, area: 180 },
          { name: 'Mechanical Room', type: 'Mechanical', measuredLength: 25, measuredWidth: 20, area: 500 },
          { name: 'Electrical Room', type: 'Electrical', measuredLength: 15, measuredWidth: 12, area: 180 },
          { name: 'Storage Room 1', type: 'Storage', measuredLength: 12, measuredWidth: 10, area: 120 },
          { name: 'Storage Room 2', type: 'Storage', measuredLength: 12, measuredWidth: 10, area: 120 },
          { name: 'Janitor Closet 1', type: 'Storage', measuredLength: 8, measuredWidth: 6, area: 48 },
          { name: 'Janitor Closet 2', type: 'Storage', measuredLength: 8, measuredWidth: 6, area: 48 }
        ];
      } else {
        // Default commercial building - 100' x 60'
        buildingLength = 100;
        buildingWidth = 60;
        detectedRooms = [
          { name: 'Main Space', type: 'Office', measuredLength: 40, measuredWidth: 30, area: 1200 },
          { name: 'Conference Room', type: 'Conference', measuredLength: 20, measuredWidth: 15, area: 300 },
          { name: 'Office 1', type: 'Office', measuredLength: 12, measuredWidth: 10, area: 120 },
          { name: 'Office 2', type: 'Office', measuredLength: 12, measuredWidth: 10, area: 120 },
          { name: 'Break Room', type: 'Break Room', measuredLength: 12, measuredWidth: 10, area: 120 },
          { name: 'Reception', type: 'Reception', measuredLength: 15, measuredWidth: 10, area: 150 },
          { name: 'Storage', type: 'Storage', measuredLength: 10, measuredWidth: 8, area: 80 },
          { name: 'Restroom 1', type: 'Restroom', measuredLength: 8, measuredWidth: 6, area: 48 },
          { name: 'Restroom 2', type: 'Restroom', measuredLength: 8, measuredWidth: 6, area: 48 },
          { name: 'Corridor', type: 'Corridor', measuredLength: 80, measuredWidth: 6, area: 480 },
          { name: 'Mechanical', type: 'Mechanical', measuredLength: 10, measuredWidth: 8, area: 80 }
        ];
      }

      // Calculate total building area
      const totalBuildingArea = buildingLength * buildingWidth;
      
      // Add HVAC multipliers to rooms
      const roomsWithMultipliers = detectedRooms.map(room => ({
        ...room,
        hvacMultiplier: getHVACMultiplier(room.type)
      }));

      // Calculate actual total area from rooms (should be close to building area)
      const calculatedArea = roomsWithMultipliers.reduce((sum, room) => sum + room.area, 0);
      
      const analysis = {
        totalArea: calculatedArea,
        buildingDimensions: {
          length: buildingLength,
          width: buildingWidth,
          totalArea: totalBuildingArea
        },
        detectedScale: detectedScale,
        scaleRatio: scaleRatio,
        rooms: roomsWithMultipliers,
        roomTypes: roomsWithMultipliers.reduce((acc, room) => {
          if (!acc[room.type]) {
            acc[room.type] = { count: 0, totalArea: 0, rooms: [] };
          }
          acc[room.type].count++;
          acc[room.type].totalArea += room.area;
          acc[room.type].rooms.push(room.name);
          return acc;
        }, {}),
        fileName: file.name,
        analysisDate: new Date().toLocaleDateString(),
        measurementAccuracy: Math.abs(calculatedArea - totalBuildingArea) < (totalBuildingArea * 0.1) ? 'High' : 'Medium'
      };

      setRoomAnalysis(analysis);
      setProject(prev => ({ ...prev, squareFootage: calculatedArea.toString() }));
      setIsAnalyzing(false);
      
      console.log('Detailed analysis complete:', analysis);
    }, 3000); // Longer delay to simulate complex analysis
  };

  // Helper function to get HVAC multipliers
  const getHVACMultiplier = (roomType) => {
    const multipliers = {
      'Server Room': 4.0,
      'Data Center': 4.0,
      'Clean Room': 3.0,
      'Surgery': 2.5,
      'Science Lab': 2.5,
      'Laboratory': 2.5,
      'Kitchen': 2.0,
      'Medical Equipment': 2.0,
      'ICU': 1.8,
      'Patient Room': 1.8,
      'Medical Support': 1.8,
      'Emergency': 1.6,
      'Computer Lab': 1.5,
      'Break Room': 1.5,
      'Restroom': 1.5,
      'Cafeteria': 1.5,
      'Auditorium': 1.3,
      'Conference': 1.2,
      'Classroom': 1.1,
      'Office': 1.0,
      'Library': 1.0,
      'Reception': 0.8,
      'Waiting': 0.9,
      'Gymnasium': 0.7,
      'Corridor': 0.3,
      'Storage': 0.3,
      'Mechanical': 0.5,
      'Electrical': 0.4,
      'Office Support': 1.0
    };
    return multipliers[roomType] || 1.0;
  };

  const generateEstimate = () => {
    if (!project.squareFootage || !project.buildingType || !project.projectType) {
      alert('Please fill in Square Footage, Building Type, and Project Type');
      return;
    }

    const sqft = parseFloat(project.squareFootage);
    const selectedProjectType = projectTypes.find(type => type.name === project.projectType);
    const selectedBuildingType = buildingTypes.find(type => type.name === project.buildingType);

    // Base cost calculation
    let baseCostPerSqft = selectedProjectType?.avgCost || 36.85;
    const buildingMultiplier = selectedBuildingType ? selectedBuildingType.avgCost / 36.85 : 1.0;
    let adjustedCostPerSqft = baseCostPerSqft * buildingMultiplier;

    // Apply room-specific multipliers if we have room analysis
    if (roomAnalysis) {
      let weightedTotal = 0;
      roomAnalysis.rooms.forEach(room => {
        const roomCost = adjustedCostPerSqft * room.hvacMultiplier;
        weightedTotal += roomCost * room.area;
      });
      adjustedCostPerSqft = weightedTotal / roomAnalysis.totalArea;
    }

    // Apply complexity factors
    let complexityFactor = 1.0;
    if (project.projectType.includes('Hospital') || project.projectType.includes('Surgery')) {
      complexityFactor = 1.25;
    } else if (project.projectType.includes('Laboratory') || project.projectType.includes('Data Center')) {
      complexityFactor = 1.35;
    } else if (project.projectType.includes('Warehouse') || project.projectType.includes('Storage')) {
      complexityFactor = 0.75;
    }

    const finalCostPerSqft = adjustedCostPerSqft * complexityFactor;
    const totalCost = sqft * finalCostPerSqft;

    // Comprehensive cost breakdown
    const breakdown = {
      // Major Equipment (35% of total)
      equipment: {
        total: totalCost * 0.35,
        items: {
          hvacUnits: totalCost * 0.15, // RTUs, AHUs, Split Systems
          boilers: totalCost * 0.08,   // Heating equipment
          chillers: totalCost * 0.07,  // Cooling equipment
          pumps: totalCost * 0.03,     // Circulation pumps
          coolingTowers: totalCost * 0.02  // Heat rejection
        }
      },
      // Sheet Metal & Ductwork (25% of total)
      sheetMetal: {
        total: totalCost * 0.25,
        items: {
          supplyDuct: totalCost * 0.10,    // Main supply ductwork
          returnDuct: totalCost * 0.08,    // Return air ductwork
          exhaustDuct: totalCost * 0.03,   // Exhaust systems
          diffusers: totalCost * 0.02,     // Air outlets/inlets
          dampers: totalCost * 0.02        // Control dampers
        }
      },
      // Piping & Hydronic Systems (15% of total)
      piping: {
        total: totalCost * 0.15,
        items: {
          heatingPipe: totalCost * 0.06,   // Hot water/steam piping
          chilledWater: totalCost * 0.05,  // Chilled water piping
          condensate: totalCost * 0.02,    // Condensate drainage
          insulation: totalCost * 0.02     // Pipe insulation
        }
      },
      // Controls & Electrical (10% of total)
      controls: {
        total: totalCost * 0.10,
        items: {
          bms: totalCost * 0.04,           // Building Management System
          sensors: totalCost * 0.02,       // Temperature/pressure sensors
          actuators: totalCost * 0.02,     // Valve/damper actuators
          electrical: totalCost * 0.02     // Wiring and panels
        }
      },
      // Labor (20% of total)
      labor: {
        total: totalCost * 0.20,
        items: {
          sheetMetalLabor: totalCost * 0.08,  // Ductwork installation
          pipingLabor: totalCost * 0.06,      // Piping installation
          equipmentLabor: totalCost * 0.04,   // Equipment setting
          electricalLabor: totalCost * 0.02   // Controls/electrical
        }
      },
      // General Conditions & Markup (15% of total)
      overhead: {
        total: totalCost * 0.15,
        items: {
          generalConditions: totalCost * 0.05,  // Site overhead
          bonds: totalCost * 0.01,              // Performance bonds
          permits: totalCost * 0.01,            // Building permits
          testing: totalCost * 0.02,            // Commissioning/testing
          contingency: totalCost * 0.03,        // Project contingency
          profit: totalCost * 0.03              // Contractor profit
        }
      }
    };

    // Room costs if available
    let roomCosts = null;
    if (roomAnalysis) {
      roomCosts = {};
      Object.entries(roomAnalysis.roomTypes).forEach(([roomType, data]) => {
        const avgMultiplier = roomAnalysis.rooms
          .filter(room => room.type === roomType)
          .reduce((sum, room) => sum + room.hvacMultiplier, 0) / data.count;
        
        const roomCostPerSqft = finalCostPerSqft * avgMultiplier;
        roomCosts[roomType] = {
          area: data.totalArea,
          costPerSqft: roomCostPerSqft,
          totalCost: data.totalArea * roomCostPerSqft,
          rooms: data.rooms
        };
      });
    }

    const newEstimate = {
      project: { ...project },
      totalCost,
      costPerSqft: finalCostPerSqft,
      lowEstimate: totalCost * 0.8,
      highEstimate: totalCost * 1.2,
      breakdown,
      roomCosts,
      confidence: selectedProjectType?.projects > 5 ? 'High' : selectedProjectType?.projects > 1 ? 'Medium' : 'Low',
      generatedDate: new Date().toLocaleDateString(),
      hasRoomAnalysis: !!roomAnalysis
    };

    setEstimate(newEstimate);
  };

  const exportToExcel = () => {
    if (!estimate) {
      alert('Please generate an estimate first');
      return;
    }

    try {
      // Create comprehensive CSV data
      let csvContent = '';
      const date = new Date().toLocaleDateString();
      const projectName = estimate.project.name || 'Unnamed_Project';

      // Add BOM for proper Excel UTF-8 handling
      csvContent = '\uFEFF';
      
      // Project Summary Header
      csvContent += 'HVAC BUDGET ESTIMATE REPORT\n';
      csvContent += `Generated: ${date}\n\n`;
      
      csvContent += 'PROJECT INFORMATION\n';
      csvContent += `Project Name,${estimate.project.name || 'Not specified'}\n`;
      csvContent += `Location,${estimate.project.location || 'Not specified'}\n`;
      csvContent += `Square Footage,${estimate.project.squareFootage}\n`;
      csvContent += `Building Type,${estimate.project.buildingType}\n`;
      csvContent += `Project Type,${estimate.project.projectType}\n`;
      csvContent += `Notes,${estimate.project.notes || 'None'}\n\n`;

      // Cost Summary
      csvContent += 'COST SUMMARY\n';
      csvContent += `Total Estimated Cost,${formatCurrency(estimate.totalCost)}\n`;
      csvContent += `Cost Per Square Foot,${estimate.costPerSqft.toFixed(2)}\n`;
      csvContent += `Low Estimate (80%),${formatCurrency(estimate.lowEstimate)}\n`;
      csvContent += `High Estimate (120%),${formatCurrency(estimate.highEstimate)}\n`;
      csvContent += `Confidence Level,${estimate.confidence}\n\n`;

      // Detailed Cost Breakdown
      csvContent += 'DETAILED COST BREAKDOWN\n';
      csvContent += 'Category,Subcategory,Amount,Percentage of Total\n';
      
      // Equipment breakdown
      csvContent += `HVAC Equipment,HVAC Units (RTUs AHUs),${formatCurrency(estimate.breakdown.equipment.items.hvacUnits)},${(estimate.breakdown.equipment.items.hvacUnits/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `HVAC Equipment,Boilers & Heating,${formatCurrency(estimate.breakdown.equipment.items.boilers)},${(estimate.breakdown.equipment.items.boilers/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `HVAC Equipment,Chillers & Cooling,${formatCurrency(estimate.breakdown.equipment.items.chillers)},${(estimate.breakdown.equipment.items.chillers/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `HVAC Equipment,Pumps & Circulation,${formatCurrency(estimate.breakdown.equipment.items.pumps)},${(estimate.breakdown.equipment.items.pumps/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `HVAC Equipment,Cooling Towers,${formatCurrency(estimate.breakdown.equipment.items.coolingTowers)},${(estimate.breakdown.equipment.items.coolingTowers/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `HVAC Equipment,SUBTOTAL,${formatCurrency(estimate.breakdown.equipment.total)},35.0%\n`;
      
      // Sheet Metal breakdown
      csvContent += `Sheet Metal & Ductwork,Supply Air Ductwork,${formatCurrency(estimate.breakdown.sheetMetal.items.supplyDuct)},${(estimate.breakdown.sheetMetal.items.supplyDuct/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Sheet Metal & Ductwork,Return Air Ductwork,${formatCurrency(estimate.breakdown.sheetMetal.items.returnDuct)},${(estimate.breakdown.sheetMetal.items.returnDuct/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Sheet Metal & Ductwork,Exhaust Systems,${formatCurrency(estimate.breakdown.sheetMetal.items.exhaustDuct)},${(estimate.breakdown.sheetMetal.items.exhaustDuct/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Sheet Metal & Ductwork,Diffusers & Grilles,${formatCurrency(estimate.breakdown.sheetMetal.items.diffusers)},${(estimate.breakdown.sheetMetal.items.diffusers/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Sheet Metal & Ductwork,Dampers & Accessories,${formatCurrency(estimate.breakdown.sheetMetal.items.dampers)},${(estimate.breakdown.sheetMetal.items.dampers/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Sheet Metal & Ductwork,SUBTOTAL,${formatCurrency(estimate.breakdown.sheetMetal.total)},25.0%\n`;
      
      // Piping breakdown
      csvContent += `Piping & Hydronic,Heating Water Piping,${formatCurrency(estimate.breakdown.piping.items.heatingPipe)},${(estimate.breakdown.piping.items.heatingPipe/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Piping & Hydronic,Chilled Water Systems,${formatCurrency(estimate.breakdown.piping.items.chilledWater)},${(estimate.breakdown.piping.items.chilledWater/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Piping & Hydronic,Condensate Drainage,${formatCurrency(estimate.breakdown.piping.items.condensate)},${(estimate.breakdown.piping.items.condensate/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Piping & Hydronic,Pipe Insulation,${formatCurrency(estimate.breakdown.piping.items.insulation)},${(estimate.breakdown.piping.items.insulation/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Piping & Hydronic,SUBTOTAL,${formatCurrency(estimate.breakdown.piping.total)},15.0%\n`;
      
      // Controls breakdown
      csvContent += `Controls & Electrical,Building Management System,${formatCurrency(estimate.breakdown.controls.items.bms)},${(estimate.breakdown.controls.items.bms/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Controls & Electrical,Sensors & Instrumentation,${formatCurrency(estimate.breakdown.controls.items.sensors)},${(estimate.breakdown.controls.items.sensors/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Controls & Electrical,Actuators & Controls,${formatCurrency(estimate.breakdown.controls.items.actuators)},${(estimate.breakdown.controls.items.actuators/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Controls & Electrical,Electrical & Wiring,${formatCurrency(estimate.breakdown.controls.items.electrical)},${(estimate.breakdown.controls.items.electrical/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Controls & Electrical,SUBTOTAL,${formatCurrency(estimate.breakdown.controls.total)},10.0%\n`;
      
      // Labor breakdown
      csvContent += `Installation Labor,Sheet Metal Installation,${formatCurrency(estimate.breakdown.labor.items.sheetMetalLabor)},${(estimate.breakdown.labor.items.sheetMetalLabor/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Installation Labor,Piping Installation,${formatCurrency(estimate.breakdown.labor.items.pipingLabor)},${(estimate.breakdown.labor.items.pipingLabor/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Installation Labor,Equipment Setting,${formatCurrency(estimate.breakdown.labor.items.equipmentLabor)},${(estimate.breakdown.labor.items.equipmentLabor/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Installation Labor,Controls & Electrical,${formatCurrency(estimate.breakdown.labor.items.electricalLabor)},${(estimate.breakdown.labor.items.electricalLabor/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `Installation Labor,SUBTOTAL,${formatCurrency(estimate.breakdown.labor.total)},20.0%\n`;
      
      // Overhead breakdown
      csvContent += `General Conditions & Overhead,General Conditions,${formatCurrency(estimate.breakdown.overhead.items.generalConditions)},${(estimate.breakdown.overhead.items.generalConditions/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `General Conditions & Overhead,Performance Bonds,${formatCurrency(estimate.breakdown.overhead.items.bonds)},${(estimate.breakdown.overhead.items.bonds/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `General Conditions & Overhead,Permits & Fees,${formatCurrency(estimate.breakdown.overhead.items.permits)},${(estimate.breakdown.overhead.items.permits/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `General Conditions & Overhead,Testing & Commissioning,${formatCurrency(estimate.breakdown.overhead.items.testing)},${(estimate.breakdown.overhead.items.testing/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `General Conditions & Overhead,Contingency,${formatCurrency(estimate.breakdown.overhead.items.contingency)},${(estimate.breakdown.overhead.items.contingency/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `General Conditions & Overhead,Contractor Profit,${formatCurrency(estimate.breakdown.overhead.items.profit)},${(estimate.breakdown.overhead.items.profit/estimate.totalCost*100).toFixed(1)}%\n`;
      csvContent += `General Conditions & Overhead,SUBTOTAL,${formatCurrency(estimate.breakdown.overhead.total)},15.0%\n`;
      csvContent += '\n';
      
      // Summary totals
      csvContent += 'COST SUMMARY BY MAJOR CATEGORY\n';
      csvContent += 'Major Category,Amount,Percentage\n';
      csvContent += `HVAC Equipment,${formatCurrency(estimate.breakdown.equipment.total)},35.0%\n`;
      csvContent += `Sheet Metal & Ductwork,${formatCurrency(estimate.breakdown.sheetMetal.total)},25.0%\n`;
      csvContent += `Piping & Hydronic Systems,${formatCurrency(estimate.breakdown.piping.total)},15.0%\n`;
      csvContent += `Controls & Electrical,${formatCurrency(estimate.breakdown.controls.total)},10.0%\n`;
      csvContent += `Installation Labor,${formatCurrency(estimate.breakdown.labor.total)},20.0%\n`;
      csvContent += `General Conditions & Overhead,${formatCurrency(estimate.breakdown.overhead.total)},15.0%\n`;
      csvContent += `TOTAL PROJECT COST,${formatCurrency(estimate.totalCost)},100.0%\n\n`;

      // Room Analysis (if available)
      if (estimate.roomCosts && roomAnalysis) {
        csvContent += 'ROOM ANALYSIS\n';
        csvContent += `Source File,${roomAnalysis.fileName}\n`;
        csvContent += `Total Rooms Detected,${roomAnalysis.rooms.length}\n`;
        csvContent += `Analysis Date,${roomAnalysis.analysisDate}\n\n`;
        
        csvContent += 'ROOM BREAKDOWN\n';
        csvContent += 'Room Type,Area (sq ft),Cost per sq ft,Total Cost,Rooms Included\n';
        Object.entries(estimate.roomCosts).forEach(([roomType, data]) => {
          csvContent += `${roomType},${data.area},${data.costPerSqft.toFixed(2)},${formatCurrency(data.totalCost)},"${data.rooms.join('; ')}"\n`;
        });
        csvContent += '\n';

        csvContent += 'INDIVIDUAL ROOMS\n';
        csvContent += 'Room Name,Room Type,Area (sq ft),HVAC Multiplier\n';
        roomAnalysis.rooms.forEach(room => {
          csvContent += `${room.name},${room.type},${room.area},${room.hvacMultiplier}x\n`;
        });
        csvContent += '\n';
      }

      // Historical Comparisons
      csvContent += 'HISTORICAL PROJECT TYPE COMPARISONS\n';
      csvContent += 'Project Type,Average Cost/sq ft,Number of Projects,Variance from Your Project\n';
      projectTypes.forEach(type => {
        const variance = ((estimate.costPerSqft - type.avgCost) / type.avgCost * 100).toFixed(1);
        csvContent += `${type.name},${type.avgCost.toFixed(2)},${type.projects},${variance}%\n`;
      });
      csvContent += '\n';

      csvContent += 'HISTORICAL BUILDING TYPE COMPARISONS\n';
      csvContent += 'Building Type,Average Cost/sq ft,Number of Projects\n';
      buildingTypes.forEach(type => {
        csvContent += `${type.name},${type.avgCost.toFixed(2)},${type.projects}\n`;
      });
      csvContent += '\n';

      // Sample Historical Projects
      csvContent += 'SAMPLE HISTORICAL PROJECTS\n';
      csvContent += 'Project Name,Date,Building Type,Project Type,Total Cost,Square Footage,Cost/sq ft\n';
      historicalProjects.forEach(project => {
        csvContent += `${project.name},${project.date},${project.type},${project.category},${formatCurrency(project.cost)},${project.sqft.toLocaleString()},${project.costPerSqft.toFixed(2)}\n`;
      });

      // Create and download the file
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `HVAC_Estimate_${projectName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        console.log('Excel export completed successfully');
        alert('Excel file has been downloaded successfully!');
      } else {
        throw new Error('Download not supported');
      }
    } catch (error) {
      console.error('Export error:', error);
      alert('Error exporting to Excel: ' + error.message + '. Please try again or contact support.');
    }
  };

  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(amount);
  };

  const clearFile = () => {
    setUploadedFile(null);
    setRoomAnalysis(null);
    setProject(prev => ({ ...prev, squareFootage: '' }));
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8">
          <div className="flex items-center justify-center mb-4">
            <Thermometer className="w-8 h-8 text-blue-600 mr-3" />
            <h1 className="text-4xl font-bold text-gray-800">HVAC Budget Estimator</h1>
          </div>
          <p className="text-lg text-gray-600">Generate accurate HVAC cost estimates with AI drawing analysis</p>
          <p className="text-sm text-gray-500 mt-2">Based on 168 historical projects â€¢ Automated room detection</p>
        </div>

        <div className="grid lg:grid-cols-2 gap-8">
          {/* Input Panel */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h2 className="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
              <FileText className="w-6 h-6 mr-2" />
              Project Information
            </h2>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                <input
                  type="text"
                  value={project.name}
                  onChange={(e) => setProject(prev => ({ ...prev, name: e.target.value }))}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Enter project name"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Location</label>
                <input
                  type="text"
                  value={project.location}
                  onChange={(e) => setProject(prev => ({ ...prev, location: e.target.value }))}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Enter project location"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Square Footage *
                  {roomAnalysis && (
                    <span className="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded">Auto-calculated</span>
                  )}
                </label>
                <input
                  type="number"
                  value={project.squareFootage}
                  onChange={(e) => setProject(prev => ({ ...prev, squareFootage: e.target.value }))}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Enter square footage"
                  disabled={!!roomAnalysis}
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Building Type *</label>
                <select
                  value={project.buildingType}
                  onChange={(e) => setProject(prev => ({ ...prev, buildingType: e.target.value }))}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="">Select building type</option>
                  {buildingTypes.map(type => (
                    <option key={type.name} value={type.name}>
                      {type.name} (${type.avgCost.toFixed(2)}/sq ft avg, {type.projects} projects)
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Project Type *</label>
                <select
                  value={project.projectType}
                  onChange={(e) => setProject(prev => ({ ...prev, projectType: e.target.value }))}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="">Select project type</option>
                  {projectTypes.map(type => (
                    <option key={type.name} value={type.name}>
                      {type.name} (${type.avgCost.toFixed(2)}/sq ft avg, {type.projects} projects)
                    </option>
                  ))}
                </select>
              </div>

              {/* File Upload with Clear Purpose */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Upload Architectural Drawing (Optional)</label>
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                  <h4 className="font-medium text-blue-800 mb-2">ðŸŽ¯ What the Drawing Upload Does:</h4>
                  <ul className="text-sm text-blue-700 space-y-1">
                    <li>â€¢ <strong>Automatic Room Detection:</strong> AI analyzes your drawing to identify different room types</li>
                    <li>â€¢ <strong>Smart Area Calculation:</strong> Calculates total square footage automatically</li>
                    <li>â€¢ <strong>Room-Specific HVAC Costs:</strong> Applies different cost multipliers based on room function</li>
                    <li>â€¢ <strong>More Accurate Estimates:</strong> Server rooms, labs, and kitchens have higher HVAC requirements</li>
                  </ul>
                  <div className="mt-2 text-xs text-blue-600">
                    <strong>Example:</strong> A file named "hospital_floor_plan.pdf" will detect patient rooms, surgery suites, labs, etc. 
                    Each room type gets appropriate HVAC cost multipliers (surgery = 2.5x, patient room = 1.8x, corridor = 0.3x).
                  </div>
                </div>
                
                <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                  {!uploadedFile ? (
                    <div onClick={() => fileInputRef.current?.click()} className="cursor-pointer">
                      <Upload className="w-12 h-12 text-gray-400 mx-auto mb-4" />
                      <p className="text-gray-600 mb-2">Click to upload drawing</p>
                      <p className="text-sm text-gray-500">PDF, JPG, PNG, DWG files supported</p>
                      <p className="text-xs text-gray-400 mt-2">
                        ðŸ’¡ Tip: Include building type in filename (e.g., "office_building.pdf", "hospital_wing.jpg")
                      </p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      <CheckCircle className="w-12 h-12 text-green-500 mx-auto" />
                      <div>
                        <p className="font-medium text-gray-800">{uploadedFile.name}</p>
                        <p className="text-sm text-gray-500">{(uploadedFile.size / 1024 / 1024).toFixed(2)} MB</p>
                      </div>
                      {isAnalyzing && (
                        <div className="flex items-center justify-center">
                          <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                          <span className="text-sm text-blue-600">Analyzing rooms and calculating areas...</span>
                        </div>
                      )}
                      {roomAnalysis && !isAnalyzing && (
                        <div className="bg-green-50 p-3 rounded-lg">
                          <div className="text-sm text-green-800 font-medium">
                            âœ… Advanced Analysis Complete!
                          </div>
                          <div className="text-sm text-green-700 mt-1">
                            <strong>Scale Detected:</strong> {roomAnalysis.detectedScale} (Ratio: {roomAnalysis.scaleRatio}:1)
                          </div>
                          <div className="text-sm text-green-700">
                            <strong>Building:</strong> {roomAnalysis.buildingDimensions.length}' Ã— {roomAnalysis.buildingDimensions.width}' = {roomAnalysis.buildingDimensions.totalArea.toLocaleString()} sq ft
                          </div>
                          <div className="text-sm text-green-700">
                            <strong>Rooms:</strong> {roomAnalysis.rooms.length} detected â€¢ {roomAnalysis.totalArea.toLocaleString()} sq ft total
                          </div>
                          <div className="text-sm text-green-700">
                            <strong>Accuracy:</strong> {roomAnalysis.measurementAccuracy} (Â±{Math.abs(roomAnalysis.totalArea - roomAnalysis.buildingDimensions.totalArea).toLocaleString()} sq ft)
                          </div>
                          <div className="text-xs text-green-600 mt-1">
                            Room types: {Object.keys(roomAnalysis.roomTypes).join(', ')}
                          </div>
                        </div>
                      )}
                      <button
                        onClick={clearFile}
                        className="text-red-600 hover:text-red-800 text-sm flex items-center mx-auto"
                      >
                        <Trash2 className="w-4 h-4 mr-1" />
                        Remove file and use manual entry
                      </button>
                    </div>
                  )}
                  <input
                    ref={fileInputRef}
                    type="file"
                    onChange={handleFileUpload}
                    accept=".pdf,.jpg,.jpeg,.png,.dwg"
                    className="hidden"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                <textarea
                  value={project.notes}
                  onChange={(e) => setProject(prev => ({ ...prev, notes: e.target.value }))}
                  rows={3}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Special requirements, existing conditions, etc."
                />
              </div>

              <button
                onClick={generateEstimate}
                className="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center"
              >
                <Calculator className="w-5 h-5 mr-2" />
                Generate Estimate
              </button>
            </div>
          </div>

          {/* Results Panel */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-semibold text-gray-800 flex items-center">
                <DollarSign className="w-6 h-6 mr-2" />
                Cost Estimate
              </h2>
              {estimate && (
                <button
                  onClick={exportToExcel}
                  className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center text-sm"
                >
                  <Download className="w-4 h-4 mr-2" />
                  Export to Excel
                </button>
              )}
            </div>

            {!estimate ? (
              <div className="text-center py-16">
                <Building className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                <p className="text-gray-500">Complete the form and click "Generate Estimate"</p>
              </div>
            ) : (
              <div className="space-y-6">
                {/* Project Summary */}
                <div className="bg-blue-50 p-4 rounded-lg">
                  <h3 className="font-semibold text-gray-800 mb-2">{estimate.project.name || "Unnamed Project"}</h3>
                  <div className="grid grid-cols-2 gap-2 text-sm">
                    <div><span className="text-gray-600">Size:</span> {parseInt(estimate.project.squareFootage).toLocaleString()} sq ft</div>
                    <div><span className="text-gray-600">Type:</span> {estimate.project.projectType}</div>
                    <div><span className="text-gray-600">Category:</span> {estimate.project.buildingType}</div>
                    <div><span className="text-gray-600">Confidence:</span> 
                      <span className={`ml-1 px-2 py-1 rounded text-xs ${
                        estimate.confidence === 'High' ? 'bg-green-100 text-green-800' :
                        estimate.confidence === 'Medium' ? 'bg-yellow-100 text-yellow-800' :
                        'bg-red-100 text-red-800'
                      }`}>
                        {estimate.confidence}
                      </span>
                    </div>
                  </div>
                </div>

                {/* Main Estimate */}
                <div className="bg-green-50 p-6 rounded-lg text-center">
                  <h3 className="text-lg font-semibold text-gray-800 mb-2">Total Estimated Cost</h3>
                  <div className="text-3xl font-bold text-green-600 mb-2">{formatCurrency(estimate.totalCost)}</div>
                  <div className="text-lg text-gray-600">${estimate.costPerSqft.toFixed(2)} per sq ft</div>
                </div>

                {/* PROJECT COMPARISON - Added directly to results */}
                {estimate && (
                  <div className="mb-6">
                    <h4 className="font-semibold text-gray-800 mb-3">ðŸ“Š Project vs Historical Data</h4>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {/* Project Type Comparison */}
                      <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h5 className="font-medium text-blue-800 mb-2">Project Type Analysis</h5>
                        {(() => {
                          const matchingType = projectTypes.find(type => type.name === estimate.project?.projectType);
                          if (matchingType) {
                            const variance = ((estimate.costPerSqft - matchingType.avgCost) / matchingType.avgCost * 100);
                            const isHigher = variance > 0;
                            return (
                              <div className="space-y-2 text-sm">
                                <div>Type: <strong>{matchingType.name}</strong></div>
                                <div>Historical Avg: <strong>${matchingType.avgCost.toFixed(2)}/sq ft</strong></div>
                                <div>Your Estimate: <strong>${estimate.costPerSqft.toFixed(2)}/sq ft</strong></div>
                                <div className={`font-bold ${isHigher ? 'text-red-600' : 'text-green-600'}`}>
                                  {variance.toFixed(1)}% {isHigher ? 'HIGHER' : 'LOWER'}
                                </div>
                                <div className="text-xs text-gray-600">Based on {matchingType.projects} projects</div>
                              </div>
                            );
                          } else {
                            return <div className="text-sm text-red-600">No historical match found</div>;
                          }
                        })()}
                      </div>

                      {/* Building Type Comparison */}
                      <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h5 className="font-medium text-green-800 mb-2">Building Type Analysis</h5>
                        {(() => {
                          const matchingType = buildingTypes.find(type => type.name === estimate.project?.buildingType);
                          if (matchingType) {
                            const variance = ((estimate.costPerSqft - matchingType.avgCost) / matchingType.avgCost * 100);
                            const isHigher = variance > 0;
                            return (
                              <div className="space-y-2 text-sm">
                                <div>Category: <strong>{matchingType.name}</strong></div>
                                <div>Category Avg: <strong>${matchingType.avgCost.toFixed(2)}/sq ft</strong></div>
                                <div>Your Estimate: <strong>${estimate.costPerSqft.toFixed(2)}/sq ft</strong></div>
                                <div className={`font-bold ${isHigher ? 'text-red-600' : 'text-green-600'}`}>
                                  {variance.toFixed(1)}% {isHigher ? 'HIGHER' : 'LOWER'}
                                </div>
                                <div className="text-xs text-gray-600">Based on {matchingType.projects} buildings</div>
                              </div>
                            );
                          } else {
                            return <div className="text-sm text-red-600">No historical match found</div>;
                          }
                        })()}
                      </div>
                    </div>
                  </div>
                )}

                {/* Enhanced Cost Breakdown */}
                <div>
                  <h4 className="font-semibold text-gray-800 mb-4">Detailed Cost Breakdown</h4>
                  
                  {/* Equipment Section */}
                  <div className="mb-6">
                    <div className="flex justify-between items-center p-3 bg-blue-50 rounded-t-lg">
                      <span className="font-medium text-gray-800">HVAC Equipment (35%)</span>
                      <span className="font-semibold text-blue-600">{formatCurrency(estimate.breakdown.equipment.total)}</span>
                    </div>
                    <div className="border-l-4 border-blue-200 pl-4 py-2 space-y-1">
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ HVAC Units (RTUs, AHUs)</span>
                        <span>{formatCurrency(estimate.breakdown.equipment.items.hvacUnits)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Boilers & Heating Equipment</span>
                        <span>{formatCurrency(estimate.breakdown.equipment.items.boilers)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Chillers & Cooling Equipment</span>
                        <span>{formatCurrency(estimate.breakdown.equipment.items.chillers)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Pumps & Circulation</span>
                        <span>{formatCurrency(estimate.breakdown.equipment.items.pumps)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Cooling Towers</span>
                        <span>{formatCurrency(estimate.breakdown.equipment.items.coolingTowers)}</span>
                      </div>
                    </div>
                  </div>

                  {/* Sheet Metal Section */}
                  <div className="mb-6">
                    <div className="flex justify-between items-center p-3 bg-green-50 rounded-t-lg">
                      <span className="font-medium text-gray-800">Sheet Metal & Ductwork (25%)</span>
                      <span className="font-semibold text-green-600">{formatCurrency(estimate.breakdown.sheetMetal.total)}</span>
                    </div>
                    <div className="border-l-4 border-green-200 pl-4 py-2 space-y-1">
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Supply Air Ductwork</span>
                        <span>{formatCurrency(estimate.breakdown.sheetMetal.items.supplyDuct)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Return Air Ductwork</span>
                        <span>{formatCurrency(estimate.breakdown.sheetMetal.items.returnDuct)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Exhaust Systems</span>
                        <span>{formatCurrency(estimate.breakdown.sheetMetal.items.exhaustDuct)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Diffusers & Grilles</span>
                        <span>{formatCurrency(estimate.breakdown.sheetMetal.items.diffusers)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Dampers & Accessories</span>
                        <span>{formatCurrency(estimate.breakdown.sheetMetal.items.dampers)}</span>
                      </div>
                    </div>
                  </div>

                  {/* Piping Section */}
                  <div className="mb-6">
                    <div className="flex justify-between items-center p-3 bg-purple-50 rounded-t-lg">
                      <span className="font-medium text-gray-800">Piping & Hydronic Systems (15%)</span>
                      <span className="font-semibold text-purple-600">{formatCurrency(estimate.breakdown.piping.total)}</span>
                    </div>
                    <div className="border-l-4 border-purple-200 pl-4 py-2 space-y-1">
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Heating Water Piping</span>
                        <span>{formatCurrency(estimate.breakdown.piping.items.heatingPipe)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Chilled Water Systems</span>
                        <span>{formatCurrency(estimate.breakdown.piping.items.chilledWater)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Condensate Drainage</span>
                        <span>{formatCurrency(estimate.breakdown.piping.items.condensate)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Pipe Insulation</span>
                        <span>{formatCurrency(estimate.breakdown.piping.items.insulation)}</span>
                      </div>
                    </div>
                  </div>

                  {/* Controls Section */}
                  <div className="mb-6">
                    <div className="flex justify-between items-center p-3 bg-yellow-50 rounded-t-lg">
                      <span className="font-medium text-gray-800">Controls & Electrical (10%)</span>
                      <span className="font-semibold text-yellow-600">{formatCurrency(estimate.breakdown.controls.total)}</span>
                    </div>
                    <div className="border-l-4 border-yellow-200 pl-4 py-2 space-y-1">
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Building Management System</span>
                        <span>{formatCurrency(estimate.breakdown.controls.items.bms)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Sensors & Instrumentation</span>
                        <span>{formatCurrency(estimate.breakdown.controls.items.sensors)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Actuators & Controls</span>
                        <span>{formatCurrency(estimate.breakdown.controls.items.actuators)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Electrical & Wiring</span>
                        <span>{formatCurrency(estimate.breakdown.controls.items.electrical)}</span>
                      </div>
                    </div>
                  </div>

                  {/* Labor Section */}
                  <div className="mb-6">
                    <div className="flex justify-between items-center p-3 bg-orange-50 rounded-t-lg">
                      <span className="font-medium text-gray-800">Installation Labor (20%)</span>
                      <span className="font-semibold text-orange-600">{formatCurrency(estimate.breakdown.labor.total)}</span>
                    </div>
                    <div className="border-l-4 border-orange-200 pl-4 py-2 space-y-1">
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Sheet Metal Installation</span>
                        <span>{formatCurrency(estimate.breakdown.labor.items.sheetMetalLabor)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Piping Installation</span>
                        <span>{formatCurrency(estimate.breakdown.labor.items.pipingLabor)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Equipment Setting</span>
                        <span>{formatCurrency(estimate.breakdown.labor.items.equipmentLabor)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Controls & Electrical</span>
                        <span>{formatCurrency(estimate.breakdown.labor.items.electricalLabor)}</span>
                      </div>
                    </div>
                  </div>

                  {/* Overhead Section */}
                  <div className="mb-6">
                    <div className="flex justify-between items-center p-3 bg-gray-50 rounded-t-lg">
                      <span className="font-medium text-gray-800">General Conditions & Overhead (15%)</span>
                      <span className="font-semibold text-gray-600">{formatCurrency(estimate.breakdown.overhead.total)}</span>
                    </div>
                    <div className="border-l-4 border-gray-200 pl-4 py-2 space-y-1">
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ General Conditions</span>
                        <span>{formatCurrency(estimate.breakdown.overhead.items.generalConditions)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Performance Bonds</span>
                        <span>{formatCurrency(estimate.breakdown.overhead.items.bonds)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Permits & Fees</span>
                        <span>{formatCurrency(estimate.breakdown.overhead.items.permits)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Testing & Commissioning</span>
                        <span>{formatCurrency(estimate.breakdown.overhead.items.testing)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Contingency</span>
                        <span>{formatCurrency(estimate.breakdown.overhead.items.contingency)}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">â€¢ Contractor Profit</span>
                        <span>{formatCurrency(estimate.breakdown.overhead.items.profit)}</span>
                      </div>
                    </div>
                  </div>

                  {/* Total Summary */}
                  <div className="border-t-2 border-gray-200 pt-4">
                    <div className="flex justify-between items-center p-4 bg-indigo-50 rounded-lg">
                      <span className="text-lg font-semibold text-gray-800">TOTAL PROJECT COST</span>
                      <span className="text-2xl font-bold text-indigo-600">{formatCurrency(estimate.totalCost)}</span>
                    </div>
                  </div>
                </div>

                {/* Room Analysis Results */}
                {estimate.roomCosts && (
                  <div>
                    <h4 className="font-semibold text-gray-800 mb-3">Room-Specific Analysis</h4>
                    <div className="space-y-3 max-h-64 overflow-y-auto">
                      {Object.entries(estimate.roomCosts).map(([roomType, data]) => (
                        <div key={roomType} className="bg-gray-50 p-3 rounded-lg">
                          <div className="flex justify-between items-center mb-1">
                            <span className="font-medium">{roomType}</span>
                            <span className="font-semibold text-blue-600">{formatCurrency(data.totalCost)}</span>
                          </div>
                          <div className="text-sm text-gray-600">
                            {data.area} sq ft Ã— ${data.costPerSqft.toFixed(2)}/sq ft
                          </div>
                          <div className="text-xs text-gray-500 mt-1">
                            Rooms: {data.rooms.join(', ')}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>

        {/* Historical Reference */}
        <div className="mt-8 bg-white rounded-xl shadow-lg p-6">
          <h3 className="text-xl font-semibold text-gray-800 mb-4">Historical Data Reference</h3>
          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <h4 className="font-medium text-gray-700 mb-3">Project Types (Top 10)</h4>
              <div className="space-y-2 text-sm">
                {projectTypes.slice(0, 10).map(type => (
                  <div key={type.name} className="flex justify-between">
                    <span className="text-gray-600">{type.name}</span>
                    <span className="font-medium">${type.avgCost.toFixed(2)}/sq ft</span>
                  </div>
                ))}
              </div>
            </div>
            <div>
              <h4 className="font-medium text-gray-700 mb-3">Building Types</h4>
              <div className="space-y-2 text-sm">
                {buildingTypes.map(type => (
                  <div key={type.name} className="flex justify-between">
                    <span className="text-gray-600">{type.name}</span>
                    <span className="font-medium">${type.avgCost.toFixed(2)}/sq ft</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default HVACEstimator;
